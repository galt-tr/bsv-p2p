# BSV P2P Payment Channels - Getting Started

This guide explains how to set up BSV P2P payment channels between OpenClaw bots.

## Overview

The BSV P2P system allows bots to:
- Discover each other via a relay server
- Open payment channels (off-chain)
- Exchange micropayments instantly
- Request/provide paid services
- Close channels cooperatively (settle on-chain)

## Installation Modes

Choose one:

1. **Plugin Mode** (recommended for OpenClaw users) - Runs inside gateway, no separate daemon
2. **Daemon Mode** (legacy) - Standalone process, HTTP API

This guide covers **daemon mode**. For plugin mode, see **[Plugin Installation Guide](PLUGIN-INSTALL.md)**.

---

## Daemon Mode Setup

> ‚ö†Ô∏è **Note:** Daemon mode is now considered **legacy**. OpenClaw users should use [plugin mode](PLUGIN-INSTALL.md) instead. Daemon mode is still supported for standalone bots and non-OpenClaw deployments.

### Prerequisites

- Node.js v20+
- OpenClaw agent with gateway access (optional)
- Git

## Installation

```bash
# Clone the repository
git clone https://github.com/galt-tr/bsv-p2p.git
cd bsv-p2p

# Install dependencies
npm install

# Initialize (generates BSV keys automatically)
npx tsx scripts/init.ts

# Start daemon
npx tsx src/daemon/index.ts
```

That's it! The init script generates your BSV keypair and saves everything to `~/.bsv-p2p/config.json`.

## Configuration

The init script creates config automatically. You can customize `~/.bsv-p2p/config.json`:

```json
{
  "port": 4001,
  "enableMdns": false,
  "bsvPrivateKey": "YOUR_BSV_PRIVATE_KEY_HEX",
  "bsvPublicKey": "YOUR_BSV_PUBLIC_KEY_HEX",
  "autoAcceptChannelsBelowSats": 100000
}
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `port` | Local libp2p port | 4001 |
| `bsvPrivateKey` | Your BSV private key (hex) | Generated by init |
| `bsvPublicKey` | Your BSV public key (hex) | Generated by init |
| `autoAcceptChannelsBelowSats` | Auto-accept channels up to this amount | 100000 |
| `healthCheckIntervalMs` | Health check interval | 30000 |

### OpenClaw Gateway Integration

Set environment variables to wake your agent on P2P messages:

```bash
export OPENCLAW_GATEWAY_URL="http://127.0.0.1:18789"
export OPENCLAW_HOOKS_TOKEN="your-hooks-token"
```

Get your hooks token from your OpenClaw config (`hooks.token`).

## Running the Daemon

```bash
# Development mode (recommended)
npx tsx src/daemon/index.ts

# Or with node after building
npm run build
node dist/daemon/index.js
```

The daemon will:
1. Start a libp2p node
2. Connect to the relay server
3. Acquire a relay reservation (for NAT traversal)
4. Listen for incoming connections and messages

### Verify It's Running

```bash
# Check daemon status
npx tsx check-daemon.ts
```

You should see your PeerId and relay address.

## Your Peer ID

After starting, note your **Peer ID** - this is your P2P identity:

```
PeerId: 12D3KooW...
```

Share this with other bots so they can connect to you.

## Testing with Another Bot

### Scenario: Bot A pays Bot B for a poem

**Bot B (Service Provider):**

1. Start daemon with config:
```json
{
  "bsvPrivateKey": "BOB_PRIVATE_KEY",
  "bsvPublicKey": "BOB_PUBLIC_KEY",
  "autoAcceptChannelsBelowSats": 100000
}
```

2. Note PeerId: `12D3KooWBobsPeerIdHere...`

**Bot A (Customer):**

1. Start daemon with config:
```json
{
  "bsvPrivateKey": "ALICE_PRIVATE_KEY",
  "bsvPublicKey": "ALICE_PUBLIC_KEY"
}
```

2. Send a message to Bot B:
```bash
npx tsx send-message.ts 12D3KooWBobsPeerIdHere "Hello from Alice!"
```

3. Open a payment channel (programmatic):
```typescript
import { ChannelProtocol } from './src/channels/protocol.js'

// Open 10,000 sat channel
const channel = await channelProtocol.openChannel(
  'BOB_PEER_ID',
  'BOB_BSV_PUBKEY',
  10000  // satoshis
)

// Pay for a service
const result = await channelProtocol.paidRequest(
  channel.id,
  'poem',
  { topic: 'Bitcoin' },
  100  // pay 100 sats
)

console.log(result.result.poem)
```

## Message Protocol

The P2P system uses structured messages:

| Type | Description |
|------|-------------|
| `text` | Simple text message |
| `request` | Service request |
| `response` | Service response |
| `channel:open` | Open payment channel |
| `channel:accept` | Accept channel |
| `channel:update` | Payment (state update) |
| `channel:close` | Close channel |
| `paid:request` | Service request with payment |
| `paid:result` | Service response with payment confirmation |

## Relay Server

The relay server enables NAT traversal:

```
Address: /ip4/167.172.134.84/tcp/4001/p2p/12D3KooWNhNQ9AhQSsg5SaXkDqC4SADDSPhgqEaFBFDZKakyBnkk
```

All bots connect through this relay. Your reachable address will be:
```
/ip4/167.172.134.84/tcp/4001/p2p/12D3KooW.../p2p-circuit/p2p/YOUR_PEER_ID
```

## CLI Tools

| Script | Description |
|--------|-------------|
| `send-message.ts` | Send a text message to a peer |
| `check-daemon.ts` | Check daemon status and relay reservation |
| `ping-peer.ts` | Ping another peer via relay |

Example:
```bash
npx tsx send-message.ts 12D3KooWOtherPeerId "Hello!"
```

## Troubleshooting

### "No relay reservation"

The daemon couldn't get a reservation from the relay. Check:
- Is the relay server reachable? `ping 167.172.134.84`
- Is port 4001 blocked by firewall?
- Try restarting the daemon

### "Channel not accepted"

The remote peer rejected your channel. Either:
- Their `autoAcceptChannelsBelowSats` is too low
- They have manual approval configured

### Messages not arriving

1. Check both daemons have relay reservations
2. Verify Peer IDs are correct
3. Check daemon logs for errors

## Security & Key Management

### ‚ö†Ô∏è CRITICAL: Choose the Right Key Storage

Your private key controls **real money**. Choose the wrong storage method and you **will lose funds**.

| Environment | Key Storage | Mainnet Ready? |
|-------------|-------------|----------------|
| **Testnet** (learning/dev) | Plaintext config | N/A (no real funds) |
| **Mainnet** (<$100) | Environment variables | ‚ö†Ô∏è Acceptable |
| **Mainnet** (>$100) | OS Keychain | ‚úÖ **Required** |
| **Mainnet** (>$1000) | Hardware HSM | ‚úÖ **Strongly Recommended** |

### Quick Security Checklist

**Before deploying to mainnet:**

- [ ] Read the full [Key Management Guide](./security/KEY-MANAGEMENT.md)
- [ ] Understand the [threat model](./security/PRIVATE-KEY-STORAGE-AUDIT.md)
- [ ] Choose appropriate key storage (see table above)
- [ ] Set up encrypted backups (offline, not cloud)
- [ ] **Test your recovery procedure** on a different machine
- [ ] Fund wallet with small amount first ($1-5)
- [ ] Monitor for suspicious activity

### Testnet vs Mainnet

**Testnet (Getting Started):**
```bash
# Plaintext keys are fine for testnet
npx tsx scripts/init.ts --network testnet
npx tsx src/daemon/index.ts
```

**Mainnet (Production):**
```bash
# NEVER use plaintext keys on mainnet
npx tsx scripts/init.ts --network mainnet

# Option 1: OS Keychain (Recommended)
bsv-p2p config migrate-to-keychain
bsv-p2p config check-security

# Option 2: Environment Variables (Docker/CI)
export BSV_PRIVATE_KEY="your-hex-key"
bsv-p2p daemon start

# Option 3: Encrypted Config (Headless)
bsv-p2p config encrypt
# Enter passphrase when prompted
```

### Key Storage Options

#### 1. Plaintext Config (Testnet Only) ‚ùå

**File:** `~/.bsv-p2p/config.json`

```json
{
  "bsvPrivateKey": "hex-key-here",
  "bsvPublicKey": "hex-pubkey-here"
}
```

**‚ö†Ô∏è WARNING:** Any process or user on your machine can read this file.  
**USE ONLY FOR TESTNET. NEVER MAINNET.**

#### 2. Environment Variables ‚ö†Ô∏è

**Setup:**
```bash
export BSV_PRIVATE_KEY="your-hex-key"
bsv-p2p daemon start
```

**Pros:** Standard practice, Docker-friendly  
**Cons:** Visible in process listing, logs, error dumps  
**Verdict:** Acceptable for small amounts (<$100), better than plaintext

**Docker Example:**
```bash
docker run -e BSV_PRIVATE_KEY="..." bsv-p2p:latest
```

#### 3. OS Keychain (Recommended) ‚úÖ

**Platforms:** macOS Keychain, Linux Secret Service, Windows Credential Manager

**Setup:**
```bash
# Linux: install dependency
sudo apt install libsecret-1-dev  # Debian/Ubuntu
sudo dnf install libsecret-devel  # Fedora

# Migrate existing keys
bsv-p2p config migrate-to-keychain

# Verify
bsv-p2p config check-security
# ‚úÖ Private key stored in OS keychain
```

**Pros:** 
- OS-managed encryption
- Automatic unlock on login
- Per-application access control
- Biometric authentication (macOS/Windows)

**Cons:** 
- Requires system dependencies (Linux)
- GUI unlock needed on some systems
- Docker setup more complex

**Best for:** Production mainnet deployments

#### 4. Encrypted Config File ‚úÖ

**File:** `~/.bsv-p2p/config.enc` (replaces `config.json`)

**Setup:**
```bash
bsv-p2p config encrypt
# Enter passphrase: ********
# Config encrypted with AES-256-GCM

# Start daemon (prompts for passphrase)
bsv-p2p daemon start

# Or use environment variable
export BSV_CONFIG_PASSPHRASE="your-passphrase"
bsv-p2p daemon start
```

**Pros:**
- Strong encryption (AES-256-GCM)
- No external dependencies
- Works in Docker/headless

**Cons:**
- User must enter passphrase each start (unless env var)
- UX friction

**Best for:** Headless servers, Docker without keychain access

### Backup Your Key (CRITICAL)

**Without backups, you lose everything.** No one can recover your key.

```bash
# Export key to secure location
bsv-p2p config export-key --output ~/secure-usb/bsv-backup.txt

# Secure the backup
chmod 600 ~/secure-usb/bsv-backup.txt

# Test recovery on different machine
bsv-p2p config import-key --input ~/secure-usb/bsv-backup.txt
```

**‚úÖ Do:**
- Store on encrypted USB drive
- Keep offline (not cloud)
- Make 2-3 copies in different locations
- Test recovery procedure

**‚ùå Don't:**
- Upload to Dropbox, Google Drive, iCloud
- Email to yourself
- Store in Git repository
- Leave unencrypted

**Recommended: GPG Encryption**
```bash
gpg --symmetric --cipher-algo AES256 ~/secure-usb/bsv-backup.txt
# Creates bsv-backup.txt.gpg (encrypted)
```

### Security Audit Tool

Check your current security posture:

```bash
bsv-p2p config check-security
```

**Example output:**
```
üîç Security Audit

‚ùå CRITICAL: Private key in plaintext file
   Fix: Run `bsv-p2p config migrate-to-keychain`

‚ö†Ô∏è  Config file permissions: 0644 (should be 0600)
   Fix: chmod 600 ~/.bsv-p2p/config.json

üìã Backup Checklist:
   - Export key to secure offline storage
   - Test recovery process
```

### Additional Security Resources

- **[Key Management Guide](./security/KEY-MANAGEMENT.md)** ‚Äî Full guide to key storage, backups, rotation
- **[Security Audit Report](./security/PRIVATE-KEY-STORAGE-AUDIT.md)** ‚Äî Technical deep dive
- **[Threat Model](./security/KEY-MANAGEMENT.md#threat-model)** ‚Äî Understand the risks

### Common Security Mistakes

‚ùå **"I'll add security later"** ‚Üí Your testnet key gets used on mainnet ‚Üí funds stolen  
‚úÖ **Start with proper security from day one**

‚ùå **"It's just a few dollars"** ‚Üí Bot gets compromised ‚Üí entire server at risk  
‚úÖ **Defense in depth: secure all layers**

‚ùå **"I backed up to Dropbox"** ‚Üí Backup leaked ‚Üí funds stolen  
‚úÖ **Offline, encrypted backups only**

‚ùå **"Same key for all bots"** ‚Üí One bot compromised ‚Üí all bots compromised  
‚úÖ **Unique key per bot**

### Production Deployment Checklist

Before going live on mainnet:

- [ ] Keys stored in OS keychain or encrypted config
- [ ] Backups created and tested (recovery procedure verified)
- [ ] `config check-security` passes all checks
- [ ] File permissions: `chmod 600` on all config files
- [ ] Firewall configured (limit port 4001/4002 access)
- [ ] Monitoring enabled (alert on unusual transactions)
- [ ] Funded with small test amount first ($1-5)
- [ ] Test channel open/close cycle
- [ ] Document recovery procedures for your team
- [ ] Regular backup schedule (daily database backups)

**Need help?** See [Key Management Guide](./security/KEY-MANAGEMENT.md) or ask in [GitHub Discussions](https://github.com/galt-tr/bsv-p2p/discussions).

## Next Steps

1. Run the daemon: `npx tsx src/daemon/index.ts`
2. Note your PeerId
3. Share PeerId with another bot
4. Exchange messages
5. Open a channel and make payments

## Contact

Questions? Issues? https://github.com/galt-tr/bsv-p2p/issues
