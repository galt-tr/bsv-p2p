(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2PCircuitRelayV2 = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2PCircuitRelayV2=(()=>{var Oo=Object.defineProperty;var bl=Object.getOwnPropertyDescriptor;var xl=Object.getOwnPropertyNames;var wl=Object.prototype.hasOwnProperty;var ve=(r,e)=>{for(var t in e)Oo(r,t,{get:e[t],enumerable:!0})},El=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of xl(e))!wl.call(r,o)&&o!==t&&Oo(r,o,{get:()=>e[o],enumerable:!(n=bl(e,o))||n.enumerable});return r};var Sl=r=>El(Oo({},"__esModule",{value:!0}),r);var hp={};ve(hp,{RELAY_V2_HOP_CODEC:()=>Ue,RELAY_V2_STOP_CODEC:()=>Wt,circuitRelayServer:()=>lp,circuitRelayTransport:()=>fp});var _e=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let o=this.#e.get(e);o==null&&(o=[],this.#e.set(e,o)),o.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let o=this.#e.get(e);o!=null&&(o=o.filter(({callback:s})=>s!==t),this.#e.set(e,o))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:o})=>!o),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var Xe=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var ie=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},Gt=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};var ln=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}};var lt=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},Ir=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}};var fn=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},hn=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};var dn=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}};var pn=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},Tt=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}};var Zt=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var mn=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},Yt=class extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}},yn=class extends Yt{constructor(e,t){super(!0,e,t)}},gn=class extends Yt{constructor(e,t){super(!1,e,t)}};var Po=Symbol.for("@libp2p/peer-id");var ba="keep-alive";function xa(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function wa(...r){let e=[];for(let t of r)xa(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Ea(...r){let e=[];for(let t of r)xa(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var va=Symbol.for("@libp2p/transport");var Sa;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Sa||(Sa={}));var _a=Symbol.for("@libp2p/service-capabilities"),Aa=Symbol.for("@libp2p/service-dependencies");var Ko={};ve(Ko,{base58btc:()=>te,base58flickr:()=>Cl});var Wp=new Uint8Array(0);function Ta(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function je(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Ia(r){return new TextEncoder().encode(r)}function Da(r){return new TextDecoder().decode(r)}function vl(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var s=r.charAt(o),i=s.charCodeAt(0);if(t[i]!==255)throw new TypeError(s+" is ambiguous");t[i]=o}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function f(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var v=0,x=0,y=0,A=h.length;y!==A&&h[y]===0;)y++,v++;for(var w=(A-y)*l+1>>>0,T=new Uint8Array(w);y!==A;){for(var P=h[y],k=0,q=w-1;(P!==0||k<x)&&q!==-1;q--,k++)P+=256*T[q]>>>0,T[q]=P%a>>>0,P=P/a>>>0;if(P!==0)throw new Error("Non-zero carry");x=k,y++}for(var S=w-x;S!==w&&T[S]===0;)S++;for(var E=c.repeat(v);S<w;++S)E+=r.charAt(T[S]);return E}function m(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var v=0;if(h[v]!==" "){for(var x=0,y=0;h[v]===c;)x++,v++;for(var A=(h.length-v)*u+1>>>0,w=new Uint8Array(A);h[v];){var T=t[h.charCodeAt(v)];if(T===255)return;for(var P=0,k=A-1;(T!==0||P<y)&&k!==-1;k--,P++)T+=a*w[k]>>>0,w[k]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");y=P,v++}if(h[v]!==" "){for(var q=A-y;q!==A&&w[q]===0;)q++;for(var S=new Uint8Array(x+(A-q)),E=x;q!==A;)S[E++]=w[q++];return S}}}function d(h){var v=m(h);if(v)return v;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:m,decode:d}}var _l=vl,Al=_l,La=Al;var No=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Uo=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let o=t.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ra(this,e)}},Mo=class{decoders;constructor(e){this.decoders=e}or(e){return Ra(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Ra(r,e){return new Mo({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var ko=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,o){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new No(e,t,n),this.decoder=new Uo(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Xt({name:r,prefix:e,encode:t,decode:n}){return new ko(r,e,t,n)}function ft({name:r,prefix:e,alphabet:t}){let{encode:n,decode:o}=La(t,r);return Xt({prefix:e,name:r,encode:n,decode:s=>je(o(s))})}function Tl(r,e,t,n){let o=r.length;for(;r[o-1]==="=";)--o;let s=new Uint8Array(o*t/8|0),i=0,a=0,c=0;for(let u=0;u<o;++u){let l=e[r[u]];if(l===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|l,i+=t,i>=8&&(i-=8,s[c++]=255&a>>i)}if(i>=t||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return s}function Il(r,e,t){let n=e[e.length-1]==="=",o=(1<<t)-1,s="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,s+=e[o&a>>i];if(i!==0&&(s+=e[o&a<<t-i]),n)for(;(s.length*t&7)!==0;)s+="=";return s}function Dl(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function ae({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let o=Dl(n);return Xt({prefix:e,name:r,encode(s){return Il(s,n,t)},decode(s){return Tl(s,o,t,r)}})}var te=ft({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Cl=ft({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var qo={};ve(qo,{base32:()=>ht,base32hex:()=>Ol,base32hexpad:()=>Nl,base32hexpadupper:()=>Ul,base32hexupper:()=>Pl,base32pad:()=>Rl,base32padupper:()=>Bl,base32upper:()=>Ll,base32z:()=>Ml});var ht=ae({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Ll=ae({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Rl=ae({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Bl=ae({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ol=ae({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Pl=ae({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Nl=ae({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ul=ae({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Ml=ae({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Vo={};ve(Vo,{base36:()=>Dr,base36upper:()=>kl});var Dr=ft({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),kl=ft({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Kl=Pa,Ba=128,ql=127,Vl=~ql,Hl=Math.pow(2,31);function Pa(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Hl;)e[t++]=r&255|Ba,r/=128;for(;r&Vl;)e[t++]=r&255|Ba,r>>>=7;return e[t]=r|0,Pa.bytes=t-n+1,e}var Fl=Ho,zl=128,Oa=127;function Ho(r,n){var t=0,n=n||0,o=0,s=n,i,a=r.length;do{if(s>=a)throw Ho.bytes=0,new RangeError("Could not decode varint");i=r[s++],t+=o<28?(i&Oa)<<o:(i&Oa)*Math.pow(2,o),o+=7}while(i>=zl);return Ho.bytes=s-n,t}var $l=Math.pow(2,7),Wl=Math.pow(2,14),Gl=Math.pow(2,21),Zl=Math.pow(2,28),Yl=Math.pow(2,35),Xl=Math.pow(2,42),jl=Math.pow(2,49),Ql=Math.pow(2,56),Jl=Math.pow(2,63),ef=function(r){return r<$l?1:r<Wl?2:r<Gl?3:r<Zl?4:r<Yl?5:r<Xl?6:r<jl?7:r<Ql?8:r<Jl?9:10},tf={encode:Kl,decode:Fl,encodingLength:ef},rf=tf,Cr=rf;function Lr(r,e=0){return[Cr.decode(r,e),Cr.decode.bytes]}function jt(r,e,t=0){return Cr.encode(r,e,t),e}function Qt(r){return Cr.encodingLength(r)}function Fe(r,e){let t=e.byteLength,n=Qt(r),o=n+Qt(t),s=new Uint8Array(o+t);return jt(r,s,0),jt(t,s,n),s.set(e,o),new Jt(r,t,e,s)}function ze(r){let e=je(r),[t,n]=Lr(e),[o,s]=Lr(e.subarray(n)),i=e.subarray(n+s);if(i.byteLength!==o)throw new Error("Incorrect length");return new Jt(t,o,i,e)}function Na(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Ta(r.bytes,t.bytes)}}var Jt=class{code;size;digest;bytes;constructor(e,t,n,o){this.code=e,this.size=t,this.digest=n,this.bytes=o}};function Ua(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return of(t,Fo(r),e??te.encoder);default:return sf(t,Fo(r),e??ht.encoder)}}var Ma=new WeakMap;function Fo(r){let e=Ma.get(r);if(e==null){let t=new Map;return Ma.set(r,t),t}return e}var le=class r{code;version;multihash;bytes;"/";constructor(e,t,n,o){this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Rr)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==af)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Fe(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Na(e.multihash,n.multihash)}toString(e){return Ua(this,e)}toJSON(){return{"/":Ua(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:o,multihash:s,bytes:i}=t;return new r(n,o,s,i??ka(n,o,s.bytes))}else if(t[cf]===!0){let{version:n,multihash:o,code:s}=t,i=ze(o);return r.create(n,s,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Rr)throw new Error(`Version 0 CID must use dag-pb (code: ${Rr}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let o=ka(e,t,n.bytes);return new r(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Rr,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,o=je(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");let s=o.subarray(t.multihashSize-t.digestSize),i=new Jt(t.multihashCode,t.digestSize,s,o);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,m]=Lr(e.subarray(t));return t+=m,f},o=n(),s=Rr;if(o===18?(o=0,t=0):s=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let i=t,a=n(),c=n(),u=t+c,l=u-i;return{version:o,codec:s,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){let[n,o]=nf(e,t),s=r.decode(o);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Fo(s).set(n,e),s}};function nf(r,e){switch(r[0]){case"Q":{let t=e??te;return[te.prefix,t.decode(`${te.prefix}${r}`)]}case te.prefix:{let t=e??te;return[te.prefix,t.decode(r)]}case ht.prefix:{let t=e??ht;return[ht.prefix,t.decode(r)]}case Dr.prefix:{let t=e??Dr;return[Dr.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function of(r,e,t){let{prefix:n}=t;if(n!==te.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let o=e.get(n);if(o==null){let s=t.encode(r).slice(1);return e.set(n,s),s}else return o}function sf(r,e,t){let{prefix:n}=t,o=e.get(n);if(o==null){let s=t.encode(r);return e.set(n,s),s}else return o}var Rr=112,af=18;function ka(r,e,t){let n=Qt(r),o=n+Qt(e),s=new Uint8Array(o+t.byteLength);return jt(r,s,0),jt(e,s,n),s.set(t,o),s}var cf=Symbol.for("@ipld/js-cid/CID");var zo={};ve(zo,{identity:()=>Me});var Ka=0,uf="identity",qa=je;function lf(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Fe(Ka,qa(r))}var Me={code:Ka,name:uf,encode:qa,digest:lf};function fe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function re(r=0){return new Uint8Array(r)}function Ae(r=0){return new Uint8Array(r)}function Je(r,e){e==null&&(e=r.reduce((o,s)=>o+s.length,0));let t=Ae(e),n=0;for(let o of r)t.set(o,n),n+=o.length;return t}var Ha=Symbol.for("@achingbrain/uint8arraylist");function Va(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let o=t+n.byteLength;if(e<o)return{buf:n,index:e-t};t=o}throw new RangeError("index is out of bounds")}function xn(r){return!!r?.[Ha]}var J=class r{bufs;length;[Ha]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(xn(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(xn(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Va(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Va(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(xn(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:o}=this._subList(e,t);return Je(n,o)}subarray(e,t){let{bufs:n,length:o}=this._subList(e,t);return n.length===1?n[0]:Je(n,o)}sublist(e,t){let{bufs:n,length:o}=this._subList(e,t),s=new r;return s.length=o,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let s=0;s<this.bufs.length;s++){let i=this.bufs[s],a=o,c=a+i.byteLength;if(o=c,e>=c)continue;let u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){n.push(i);break}let f=e-a;n.push(i.subarray(f,f+(t-e)));break}if(u){if(e===0){n.push(i);continue}n.push(i.subarray(e-a));continue}if(l){if(t===c){n.push(i);break}n.push(i.subarray(0,t-a));break}n.push(i)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!xn(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let s=256,i=new Int32Array(s);for(let f=0;f<s;f++)i[f]=-1;for(let f=0;f<o;f++)i[n[f]]=f;let a=i,c=this.byteLength-n.byteLength,u=n.byteLength-1,l;for(let f=t;f<=c;f+=l){l=0;for(let m=u;m>=0;m--){let d=this.get(f+m);if(n[m]!==d){l=Math.max(1,m-a[d]);break}}if(l===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Ae(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let o=re(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,t,n),this.write(o,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let o=re(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,t,n),this.write(o,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let o=re(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,t,n),this.write(o,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Ae(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let o=re(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,t,n),this.write(o,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let o=re(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,t,n),this.write(o,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let o=re(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,t,n),this.write(o,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let o=re(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,t,n),this.write(o,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let o=re(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,t,n),this.write(o,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!fe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((o,s)=>o+s.byteLength,0)),n.length=t,n}};var $o={};ve($o,{base10:()=>ff});var ff=ft({prefix:"9",name:"base10",alphabet:"0123456789"});var Wo={};ve(Wo,{base16:()=>hf,base16upper:()=>df});var hf=ae({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),df=ae({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Go={};ve(Go,{base2:()=>pf});var pf=ae({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Zo={};ve(Zo,{base256emoji:()=>xf});var Fa=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),mf=Fa.reduce((r,e,t)=>(r[t]=e,r),[]),yf=Fa.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function gf(r){return r.reduce((e,t)=>(e+=mf[t],e),"")}function bf(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let o=yf[n];if(o==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(o)}return new Uint8Array(e)}var xf=Xt({prefix:"\u{1F680}",name:"base256emoji",encode:gf,decode:bf});var Xo={};ve(Xo,{base64:()=>wf,base64pad:()=>Ef,base64url:()=>Yo,base64urlpad:()=>Sf});var wf=ae({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ef=ae({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Yo=ae({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Sf=ae({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var jo={};ve(jo,{base8:()=>vf});var vf=ae({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Qo={};ve(Qo,{identity:()=>_f});var _f=Xt({prefix:"\0",name:"identity",encode:r=>Da(r),decode:r=>Ia(r)});var Cm=new TextEncoder,Lm=new TextDecoder;var ts={};ve(ts,{sha256:()=>er,sha512:()=>Df});var If=20;function es({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:o}){return new Jo(r,e,t,n,o)}var Jo=class{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,o,s){this.name=e,this.code=t,this.encode=n,this.minDigestLength=o??If,this.maxDigestLength=s}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){let n=this.encode(e);return n instanceof Uint8Array?za(n,this.code,t?.truncate):n.then(o=>za(o,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}};function za(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Fe(e,r)}function Wa(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var er=es({name:"sha2-256",code:18,encode:Wa("SHA-256")}),Df=es({name:"sha2-512",code:19,encode:Wa("SHA-512")});var Br={...Qo,...Go,...jo,...$o,...Wo,...qo,...Vo,...Ko,...Xo,...Zo},Hm={...ts,...zo};function Za(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var Ga=Za("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),rs=Za("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Ae(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Cf={utf8:Ga,"utf-8":Ga,hex:Br.base16,latin1:rs,ascii:rs,binary:rs,...Br},wn=Cf;function K(r,e="utf8"){let t=wn[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function $(r,e="utf8"){let t=wn[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var Lf=parseInt("11111",2),ns=parseInt("10000000",2),Rf=parseInt("01111111",2),Ya={0:Or,1:Or,2:Bf,3:Nf,4:Uf,5:Pf,6:Of,16:Or,22:Or,48:Or};function et(r,e={offset:0}){let t=r[e.offset]&Lf;if(e.offset++,Ya[t]!=null)return Ya[t](r,e);throw new Error("No decoder for tag "+t)}function Pr(r,e){let t=0;if((r[e.offset]&ns)===ns){let n=r[e.offset]&Rf,o="0x";e.offset++;for(let s=0;s<n;s++,e.offset++)o+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(o,16)}else t=r[e.offset],e.offset++;return t}function Or(r,e){Pr(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=et(r,e);if(n===null)break;t.push(n)}return t}function Bf(r,e){let t=Pr(r,e),n=e.offset,o=e.offset+t,s=[];for(let i=n;i<o;i++)i===n&&r[i]===0||s.push(r[i]);return e.offset+=t,Uint8Array.from(s)}function Of(r,e){let t=Pr(r,e),n=e.offset+t,o=r[e.offset];e.offset++;let s=0,i=0;o<40?(s=0,i=o):o<80?(s=1,i=o-40):(s=2,i=o-80);let a=`${s}.${i}`,c=[];for(;e.offset<n;){let u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let l=0;for(let f=0;f<c.length;f++)l+=c[f]<<f*7;a+=`.${l}`,c=[]}}return a}function Pf(r,e){return e.offset++,null}function Nf(r,e){let t=Pr(r,e),n=r[e.offset];e.offset++;let o=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function Uf(r,e){let t=Pr(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Mf(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new J;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function os(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=Mf(r.byteLength);return new J(Uint8Array.from([e.byteLength|ns]),e)}function Te(r){let e=new J,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new J(Uint8Array.from([2]),os(e),e)}function En(r){let e=Uint8Array.from([0]),t=new J(e,r);return new J(Uint8Array.from([3]),os(t),t)}function dt(r,e=48){let t=new J;for(let n of r)t.append(n);return new J(Uint8Array.from([e]),os(t),t)}async function Xa(r,e,t,n){let o=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let s=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,e,t.subarray());return n?.signal?.throwIfAborted(),s}var kf=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Kf=Uint8Array.from([6,5,43,129,4,0,34]),qf=Uint8Array.from([6,5,43,129,4,0,35]),Vf={ext:!0,kty:"EC",crv:"P-256"},Hf={ext:!0,kty:"EC",crv:"P-384"},Ff={ext:!0,kty:"EC",crv:"P-521"},ss=32,is=48,as=66;function cs(r){let e=et(r);return ja(e)}function ja(r){let e=r[1][1][0],t=1,n,o;if(e.byteLength===ss*2+1)return n=$(e.subarray(t,t+ss),"base64url"),o=$(e.subarray(t+ss),"base64url"),new tr({...Vf,key_ops:["verify"],x:n,y:o});if(e.byteLength===is*2+1)return n=$(e.subarray(t,t+is),"base64url"),o=$(e.subarray(t+is),"base64url"),new tr({...Hf,key_ops:["verify"],x:n,y:o});if(e.byteLength===as*2+1)return n=$(e.subarray(t,t+as),"base64url"),o=$(e.subarray(t+as),"base64url"),new tr({...Ff,key_ops:["verify"],x:n,y:o});throw new ie(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Qa(r){return dt([Te(Uint8Array.from([1])),dt([zf(r.crv)],160),dt([En(new J(Uint8Array.from([4]),K(r.x??"","base64url"),K(r.y??"","base64url")))],161)]).subarray()}function zf(r){if(r==="P-256")return kf;if(r==="P-384")return Kf;if(r==="P-521")return qf;throw new ie(`Invalid curve ${r}`)}var tr=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=Qa(this.jwk)),this._raw}toMultihash(){return Me.digest($e(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return te.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:fe(this.raw,e.raw)}async verify(e,t,n){return Xa(this.jwk,t,e,n)}};function It(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function We(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function M(r,e,t=""){let n=It(r),o=r?.length,s=e!==void 0;if(!n||s&&o!==e){let i=t&&`"${t}" `,a=s?` of length ${e}`:"",c=n?`length=${o}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function Sn(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");We(r.outputLen),We(r.blockLen)}function rr(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function ec(r,e){M(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function rt(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function vn(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function ke(r,e){return r<<32-e|r>>>e}var tc=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",$f=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function nt(r){if(M(r),tc)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=$f[r[t]];return e}var tt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Ja(r){if(r>=tt._0&&r<=tt._9)return r-tt._0;if(r>=tt.A&&r<=tt.F)return r-(tt.A-10);if(r>=tt.a&&r<=tt.f)return r-(tt.a-10)}function ot(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(tc)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let o=0,s=0;o<t;o++,s+=2){let i=Ja(r.charCodeAt(s)),a=Ja(r.charCodeAt(s+1));if(i===void 0||a===void 0){let c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[o]=i*16+a}return n}function Ie(...r){let e=0;for(let n=0;n<r.length;n++){let o=r[n];M(o),e+=o.length}let t=new Uint8Array(e);for(let n=0,o=0;n<r.length;n++){let s=r[n];t.set(s,o),o+=s.length}return t}function us(r,e={}){let t=(o,s)=>r(s).update(o).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=o=>r(o),Object.assign(t,e),Object.freeze(t)}function nr(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var ls=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function rc(r,e,t){return r&e^~r&t}function nc(r,e,t){return r&e^r&t^e&t}var Nr=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,o){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(e),this.view=vn(this.buffer)}update(e){rr(this),M(e);let{view:t,buffer:n,blockLen:o}=this,s=e.length;for(let i=0;i<s;){let a=Math.min(o-this.pos,s-i);if(a===o){let c=vn(e);for(;o<=s-i;i+=o)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){rr(this),ec(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:s}=this,{pos:i}=this;t[i++]=128,rt(this.buffer.subarray(i)),this.padOffset>o-i&&(this.process(n,0),i=0);for(let f=i;f<o;f++)t[f]=0;n.setBigUint64(o-8,BigInt(this.length*8),s),this.process(n,0);let a=vn(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)a.setUint32(4*f,l[f],s)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:s,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=s,e.length=o,e.pos=a,o%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},st=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var ye=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var _n=BigInt(4294967295),oc=BigInt(32);function Wf(r,e=!1){return e?{h:Number(r&_n),l:Number(r>>oc&_n)}:{h:Number(r>>oc&_n)|0,l:Number(r&_n)|0}}function sc(r,e=!1){let t=r.length,n=new Uint32Array(t),o=new Uint32Array(t);for(let s=0;s<t;s++){let{h:i,l:a}=Wf(r[s],e);[n[s],o[s]]=[i,a]}return[n,o]}var fs=(r,e,t)=>r>>>t,hs=(r,e,t)=>r<<32-t|e>>>t,Dt=(r,e,t)=>r>>>t|e<<32-t,Ct=(r,e,t)=>r<<32-t|e>>>t,Ur=(r,e,t)=>r<<64-t|e>>>t-32,Mr=(r,e,t)=>r>>>t-32|e<<64-t;function Ge(r,e,t,n){let o=(e>>>0)+(n>>>0);return{h:r+t+(o/2**32|0)|0,l:o|0}}var ic=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),ac=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,cc=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),uc=(r,e,t,n,o)=>e+t+n+o+(r/2**32|0)|0,lc=(r,e,t,n,o)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(o>>>0),fc=(r,e,t,n,o,s)=>e+t+n+o+s+(r/2**32|0)|0;var Zf=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),pt=new Uint32Array(64),ds=class extends Nr{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:o,E:s,F:i,G:a,H:c}=this;return[e,t,n,o,s,i,a,c]}set(e,t,n,o,s,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)pt[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let m=pt[f-15],d=pt[f-2],h=ke(m,7)^ke(m,18)^m>>>3,v=ke(d,17)^ke(d,19)^d>>>10;pt[f]=v+pt[f-7]+h+pt[f-16]|0}let{A:n,B:o,C:s,D:i,E:a,F:c,G:u,H:l}=this;for(let f=0;f<64;f++){let m=ke(a,6)^ke(a,11)^ke(a,25),d=l+m+rc(a,c,u)+Zf[f]+pt[f]|0,v=(ke(n,2)^ke(n,13)^ke(n,22))+nc(n,o,s)|0;l=u,u=c,c=a,a=i+d|0,i=s,s=o,o=n,n=d+v|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,s,i,a,c,u,l)}roundClean(){rt(pt)}destroy(){this.set(0,0,0,0,0,0,0,0),rt(this.buffer)}},ps=class extends ds{A=st[0]|0;B=st[1]|0;C=st[2]|0;D=st[3]|0;E=st[4]|0;F=st[5]|0;G=st[6]|0;H=st[7]|0;constructor(){super(32)}};var hc=sc(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Yf=hc[0],Xf=hc[1],mt=new Uint32Array(80),yt=new Uint32Array(80),ms=class extends Nr{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:o,Ch:s,Cl:i,Dh:a,Dl:c,Eh:u,El:l,Fh:f,Fl:m,Gh:d,Gl:h,Hh:v,Hl:x}=this;return[e,t,n,o,s,i,a,c,u,l,f,m,d,h,v,x]}set(e,t,n,o,s,i,a,c,u,l,f,m,d,h,v,x){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=o|0,this.Ch=s|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=l|0,this.Fh=f|0,this.Fl=m|0,this.Gh=d|0,this.Gl=h|0,this.Hh=v|0,this.Hl=x|0}process(e,t){for(let w=0;w<16;w++,t+=4)mt[w]=e.getUint32(t),yt[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let T=mt[w-15]|0,P=yt[w-15]|0,k=Dt(T,P,1)^Dt(T,P,8)^fs(T,P,7),q=Ct(T,P,1)^Ct(T,P,8)^hs(T,P,7),S=mt[w-2]|0,E=yt[w-2]|0,N=Dt(S,E,19)^Ur(S,E,61)^fs(S,E,6),V=Ct(S,E,19)^Mr(S,E,61)^hs(S,E,6),L=cc(q,V,yt[w-7],yt[w-16]),g=uc(L,k,N,mt[w-7],mt[w-16]);mt[w]=g|0,yt[w]=L|0}let{Ah:n,Al:o,Bh:s,Bl:i,Ch:a,Cl:c,Dh:u,Dl:l,Eh:f,El:m,Fh:d,Fl:h,Gh:v,Gl:x,Hh:y,Hl:A}=this;for(let w=0;w<80;w++){let T=Dt(f,m,14)^Dt(f,m,18)^Ur(f,m,41),P=Ct(f,m,14)^Ct(f,m,18)^Mr(f,m,41),k=f&d^~f&v,q=m&h^~m&x,S=lc(A,P,q,Xf[w],yt[w]),E=fc(S,y,T,k,Yf[w],mt[w]),N=S|0,V=Dt(n,o,28)^Ur(n,o,34)^Ur(n,o,39),L=Ct(n,o,28)^Mr(n,o,34)^Mr(n,o,39),g=n&s^n&a^s&a,b=o&i^o&c^i&c;y=v|0,A=x|0,v=d|0,x=h|0,d=f|0,h=m|0,{h:f,l:m}=Ge(u|0,l|0,E|0,N|0),u=a|0,l=c|0,a=s|0,c=i|0,s=n|0,i=o|0;let p=ic(N,L,b);n=ac(p,E,V,g),o=p|0}({h:n,l:o}=Ge(this.Ah|0,this.Al|0,n|0,o|0)),{h:s,l:i}=Ge(this.Bh|0,this.Bl|0,s|0,i|0),{h:a,l:c}=Ge(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l}=Ge(this.Dh|0,this.Dl|0,u|0,l|0),{h:f,l:m}=Ge(this.Eh|0,this.El|0,f|0,m|0),{h:d,l:h}=Ge(this.Fh|0,this.Fl|0,d|0,h|0),{h:v,l:x}=Ge(this.Gh|0,this.Gl|0,v|0,x|0),{h:y,l:A}=Ge(this.Hh|0,this.Hl|0,y|0,A|0),this.set(n,o,s,i,a,c,u,l,f,m,d,h,v,x,y,A)}roundClean(){rt(mt,yt)}destroy(){rt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},ys=class extends ms{Ah=ye[0]|0;Al=ye[1]|0;Bh=ye[2]|0;Bl=ye[3]|0;Ch=ye[4]|0;Cl=ye[5]|0;Dh=ye[6]|0;Dl=ye[7]|0;Eh=ye[8]|0;El=ye[9]|0;Fh=ye[10]|0;Fl=ye[11]|0;Gh=ye[12]|0;Gl=ye[13]|0;Hh=ye[14]|0;Hl=ye[15]|0;constructor(){super(64)}};var or=us(()=>new ps,ls(1));var dc=us(()=>new ys,ls(3));var bs=BigInt(0),gs=BigInt(1);function it(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function pc(r){if(typeof r=="bigint"){if(!An(r))throw new Error("positive bigint expected, got "+r)}else We(r);return r}function kr(r){let e=pc(r).toString(16);return e.length&1?"0"+e:e}function mc(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?bs:BigInt("0x"+r)}function sr(r){return mc(nt(r))}function Lt(r){return mc(nt(In(M(r)).reverse()))}function Tn(r,e){We(e),r=pc(r);let t=ot(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function xs(r,e){return Tn(r,e).reverse()}function In(r){return Uint8Array.from(r)}var An=r=>typeof r=="bigint"&&bs<=r;function jf(r,e,t){return An(r)&&An(e)&&An(t)&&e<=r&&r<t}function Kr(r,e,t,n){if(!jf(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function ws(r){let e;for(e=0;r>bs;r>>=gs,e+=1);return e}var qr=r=>(gs<<BigInt(r))-gs;function yc(r,e,t){if(We(r,"hashLen"),We(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=x=>new Uint8Array(x),o=Uint8Array.of(),s=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(r),u=n(r),l=0,f=()=>{c.fill(1),u.fill(0),l=0},m=(...x)=>t(u,Ie(c,...x)),d=(x=o)=>{u=m(s,x),c=m(),x.length!==0&&(u=m(i,x),c=m())},h=()=>{if(l++>=a)throw new Error("drbg: tried max amount of iterations");let x=0,y=[];for(;x<e;){c=m();let A=c.slice();y.push(A),x+=c.length}return Ie(...y)};return(x,y)=>{f(),d(x);let A;for(;!(A=y(h()));)d();return f(),A}}function gt(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,i,a){let c=r[s];if(a&&c===void 0)return;let u=typeof c;if(u!==i||c===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${u}`)}let o=(s,i)=>Object.entries(s).forEach(([a,c])=>n(a,c,i));o(e,!1),o(t,!0)}function ir(r){let e=new WeakMap;return(t,...n)=>{let o=e.get(t);if(o!==void 0)return o;let s=r(t,...n);return e.set(t,s),s}}var Se=BigInt(0),he=BigInt(1),Rt=BigInt(2),xc=BigInt(3),wc=BigInt(4),Ec=BigInt(5),Qf=BigInt(7),Sc=BigInt(8),Jf=BigInt(9),vc=BigInt(16);function ce(r,e){let t=r%e;return t>=Se?t:e+t}function ee(r,e,t){let n=r;for(;e-- >Se;)n*=n,n%=t;return n}function gc(r,e){if(r===Se)throw new Error("invert: expected non-zero number");if(e<=Se)throw new Error("invert: expected positive modulus, got "+e);let t=ce(r,e),n=e,o=Se,s=he,i=he,a=Se;for(;t!==Se;){let u=n/t,l=n%t,f=o-i*u,m=s-a*u;n=t,t=l,o=i,s=a,i=f,a=m}if(n!==he)throw new Error("invert: does not exist");return ce(o,e)}function Ss(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function _c(r,e){let t=(r.ORDER+he)/wc,n=r.pow(e,t);return Ss(r,n,e),n}function eh(r,e){let t=(r.ORDER-Ec)/Sc,n=r.mul(e,Rt),o=r.pow(n,t),s=r.mul(e,o),i=r.mul(r.mul(s,Rt),o),a=r.mul(s,r.sub(i,r.ONE));return Ss(r,a,e),a}function th(r){let e=ar(r),t=Ac(r),n=t(e,e.neg(e.ONE)),o=t(e,n),s=t(e,e.neg(n)),i=(r+Qf)/vc;return(a,c)=>{let u=a.pow(c,i),l=a.mul(u,n),f=a.mul(u,o),m=a.mul(u,s),d=a.eql(a.sqr(l),c),h=a.eql(a.sqr(f),c);u=a.cmov(u,l,d),l=a.cmov(m,f,h);let v=a.eql(a.sqr(l),c),x=a.cmov(u,l,v);return Ss(a,x,c),x}}function Ac(r){if(r<xc)throw new Error("sqrt is not defined for small field");let e=r-he,t=0;for(;e%Rt===Se;)e/=Rt,t++;let n=Rt,o=ar(r);for(;bc(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return _c;let s=o.pow(n,e),i=(e+he)/Rt;return function(c,u){if(c.is0(u))return u;if(bc(c,u)!==1)throw new Error("Cannot find square root");let l=t,f=c.mul(c.ONE,s),m=c.pow(u,e),d=c.pow(u,i);for(;!c.eql(m,c.ONE);){if(c.is0(m))return c.ZERO;let h=1,v=c.sqr(m);for(;!c.eql(v,c.ONE);)if(h++,v=c.sqr(v),h===l)throw new Error("Cannot find square root");let x=he<<BigInt(l-h-1),y=c.pow(f,x);l=h,f=c.sqr(y),m=c.mul(m,f),d=c.mul(d,y)}return d}}function rh(r){return r%wc===xc?_c:r%Sc===Ec?eh:r%vc===Jf?th(r):Ac(r)}var Tc=(r,e)=>(ce(r,e)&he)===he,nh=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function vs(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=nh.reduce((n,o)=>(n[o]="function",n),e);return gt(r,t),r}function oh(r,e,t){if(t<Se)throw new Error("invalid exponent, negatives unsupported");if(t===Se)return r.ONE;if(t===he)return e;let n=r.ONE,o=e;for(;t>Se;)t&he&&(n=r.mul(n,o)),o=r.sqr(o),t>>=he;return n}function Vr(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),o=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),s=r.inv(o);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),s),n}function bc(r,e){let t=(r.ORDER-he)/Rt,n=r.pow(e,t),o=r.eql(n,r.ONE),s=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!o&&!s&&!i)throw new Error("invalid Legendre symbol result");return o?1:s?0:-1}function sh(r,e){e!==void 0&&We(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var Es=class{ORDER;BITS;BYTES;isLE;ZERO=Se;ONE=he;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=Se)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:o,nByteLength:s}=sh(e,n);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=o,this.BYTES=s,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return ce(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Se<=e&&e<this.ORDER}is0(e){return e===Se}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&he)===he}neg(e){return ce(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return ce(e*e,this.ORDER)}add(e,t){return ce(e+t,this.ORDER)}sub(e,t){return ce(e-t,this.ORDER)}mul(e,t){return ce(e*t,this.ORDER)}pow(e,t){return oh(this,e,t)}div(e,t){return ce(e*gc(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return gc(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=rh(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?xs(e,this.BYTES):Tn(e,this.BYTES)}fromBytes(e,t=!1){M(e);let{_lengths:n,BYTES:o,isLE:s,ORDER:i,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>o)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let u=new Uint8Array(o);u.set(e,s?0:u.length-e.length),e=u}if(e.length!==o)throw new Error("Field.fromBytes: expected "+o+" bytes, got "+e.length);let c=s?Lt(e):sr(e);if(a&&(c=ce(c,i)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return Vr(this,e)}cmov(e,t,n){return n?t:e}};function ar(r,e={}){return new Es(r,e)}function Ic(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function _s(r){let e=Ic(r);return e+Math.ceil(e/2)}function As(r,e,t=!1){M(r);let n=r.length,o=Ic(e),s=_s(e);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);let i=t?Lt(r):sr(r),a=ce(i,e-he)+he;return t?xs(a,o):Tn(a,o)}var cr=BigInt(0),Bt=BigInt(1);function Hr(r,e){let t=e.negate();return r?t:e}function Ot(r,e){let t=Vr(r.Fp,e.map(n=>n.Z));return e.map((n,o)=>r.fromAffine(n.toAffine(t[o])))}function Rc(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Ts(r,e){Rc(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),o=2**r,s=qr(r),i=BigInt(r);return{windows:t,windowSize:n,mask:s,maxNumber:o,shiftBy:i}}function Dc(r,e,t){let{windowSize:n,mask:o,maxNumber:s,shiftBy:i}=t,a=Number(r&o),c=r>>i;a>n&&(a-=s,c+=Bt);let u=e*n,l=u+Math.abs(a)-1,f=a===0,m=a<0,d=e%2!==0;return{nextN:c,offset:l,isZero:f,isNeg:m,isNegF:d,offsetF:u}}var Is=new WeakMap,Bc=new WeakMap;function Ds(r){return Bc.get(r)||1}function Cc(r){if(r!==cr)throw new Error("invalid wNAF")}var ur=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let o=e;for(;t>cr;)t&Bt&&(n=n.add(o)),o=o.double(),t>>=Bt;return n}precomputeWindow(e,t){let{windows:n,windowSize:o}=Ts(t,this.bits),s=[],i=e,a=i;for(let c=0;c<n;c++){a=i,s.push(a);for(let u=1;u<o;u++)a=a.add(i),s.push(a);i=a.double()}return s}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let o=this.ZERO,s=this.BASE,i=Ts(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:l,isNeg:f,isNegF:m,offsetF:d}=Dc(n,a,i);n=c,l?s=s.add(Hr(m,t[d])):o=o.add(Hr(f,t[u]))}return Cc(n),{p:o,f:s}}wNAFUnsafe(e,t,n,o=this.ZERO){let s=Ts(e,this.bits);for(let i=0;i<s.windows&&n!==cr;i++){let{nextN:a,offset:c,isZero:u,isNeg:l}=Dc(n,i,s);if(n=a,!u){let f=t[c];o=o.add(l?f.negate():f)}}return Cc(n),o}getPrecomputes(e,t,n){let o=Is.get(t);return o||(o=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(o=n(o)),Is.set(t,o))),o}cached(e,t,n){let o=Ds(e);return this.wNAF(o,this.getPrecomputes(o,e,n),t)}unsafe(e,t,n,o){let s=Ds(e);return s===1?this._unsafeLadder(e,t,o):this.wNAFUnsafe(s,this.getPrecomputes(s,e,n),t,o)}createCache(e,t){Rc(t,this.bits),Bc.set(e,t),Is.delete(e)}hasCache(e){return Ds(e)!==1}};function Oc(r,e,t,n){let o=e,s=r.ZERO,i=r.ZERO;for(;t>cr||n>cr;)t&Bt&&(s=s.add(o)),n&Bt&&(i=i.add(o)),o=o.double(),t>>=Bt,n>>=Bt;return{p1:s,p2:i}}function Lc(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return vs(e),e}else return ar(r,{isLE:t})}function Dn(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>cr))throw new Error(`CURVE.${c} must be positive bigint`)}let o=Lc(e.p,t.Fp,n),s=Lc(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!o.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:o,Fn:s}}function Cn(r,e){return function(n){let o=r(n);return{secretKey:o,publicKey:e(o)}}}var bt=BigInt(0),de=BigInt(1),Cs=BigInt(2),ih=BigInt(8);function ah(r,e,t,n){let o=r.sqr(t),s=r.sqr(n),i=r.add(r.mul(e.a,o),s),a=r.add(r.ONE,r.mul(e.d,r.mul(o,s)));return r.eql(i,a)}function Pc(r,e={}){let t=Dn("edwards",r,e,e.FpFnLE),{Fp:n,Fn:o}=t,s=t.CURVE,{h:i}=s;gt(e,{},{uvRatio:"function"});let a=Cs<<BigInt(o.BYTES*8)-de,c=x=>n.create(x),u=e.uvRatio||((x,y)=>{try{return{isValid:!0,value:n.sqrt(n.div(x,y))}}catch{return{isValid:!1,value:bt}}});if(!ah(n,s,s.Gx,s.Gy))throw new Error("bad curve params: generator point");function l(x,y,A=!1){let w=A?de:bt;return Kr("coordinate "+x,y,w,a),y}function f(x){if(!(x instanceof h))throw new Error("EdwardsPoint expected")}let m=ir((x,y)=>{let{X:A,Y:w,Z:T}=x,P=x.is0();y==null&&(y=P?ih:n.inv(T));let k=c(A*y),q=c(w*y),S=n.mul(T,y);if(P)return{x:bt,y:de};if(S!==de)throw new Error("invZ was invalid");return{x:k,y:q}}),d=ir(x=>{let{a:y,d:A}=s;if(x.is0())throw new Error("bad point: ZERO");let{X:w,Y:T,Z:P,T:k}=x,q=c(w*w),S=c(T*T),E=c(P*P),N=c(E*E),V=c(q*y),L=c(E*c(V+S)),g=c(N+c(A*c(q*S)));if(L!==g)throw new Error("bad point: equation left != right (1)");let b=c(w*T),p=c(P*k);if(b!==p)throw new Error("bad point: equation left != right (2)");return!0});class h{static BASE=new h(s.Gx,s.Gy,de,c(s.Gx*s.Gy));static ZERO=new h(bt,de,de,bt);static Fp=n;static Fn=o;X;Y;Z;T;constructor(y,A,w,T){this.X=l("x",y),this.Y=l("y",A),this.Z=l("z",w,!0),this.T=l("t",T),Object.freeze(this)}static CURVE(){return s}static fromAffine(y){if(y instanceof h)throw new Error("extended point not allowed");let{x:A,y:w}=y||{};return l("x",A),l("y",w),new h(A,w,de,c(A*w))}static fromBytes(y,A=!1){let w=n.BYTES,{a:T,d:P}=s;y=In(M(y,w,"point")),it(A,"zip215");let k=In(y),q=y[w-1];k[w-1]=q&-129;let S=Lt(k),E=A?a:n.ORDER;Kr("point.y",S,bt,E);let N=c(S*S),V=c(N-de),L=c(P*N-T),{isValid:g,value:b}=u(V,L);if(!g)throw new Error("bad point: invalid y coordinate");let p=(b&de)===de,_=(q&128)!==0;if(!A&&b===bt&&_)throw new Error("bad point: x=0 and x_0=1");return _!==p&&(b=c(-b)),h.fromAffine({x:b,y:S})}static fromHex(y,A=!1){return h.fromBytes(ot(y),A)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,A=!0){return v.createCache(this,y),A||this.multiply(Cs),this}assertValidity(){d(this)}equals(y){f(y);let{X:A,Y:w,Z:T}=this,{X:P,Y:k,Z:q}=y,S=c(A*q),E=c(P*T),N=c(w*q),V=c(k*T);return S===E&&N===V}is0(){return this.equals(h.ZERO)}negate(){return new h(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:y}=s,{X:A,Y:w,Z:T}=this,P=c(A*A),k=c(w*w),q=c(Cs*c(T*T)),S=c(y*P),E=A+w,N=c(c(E*E)-P-k),V=S+k,L=V-q,g=S-k,b=c(N*L),p=c(V*g),_=c(N*g),I=c(L*V);return new h(b,p,I,_)}add(y){f(y);let{a:A,d:w}=s,{X:T,Y:P,Z:k,T:q}=this,{X:S,Y:E,Z:N,T:V}=y,L=c(T*S),g=c(P*E),b=c(q*w*V),p=c(k*N),_=c((T+P)*(S+E)-L-g),I=p-b,C=p+b,R=c(g-A*L),D=c(_*I),O=c(C*R),U=c(_*R),ne=c(I*C);return new h(D,O,ne,U)}subtract(y){return this.add(y.negate())}multiply(y){if(!o.isValidNot0(y))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:A,f:w}=v.cached(this,y,T=>Ot(h,T));return Ot(h,[A,w])[0]}multiplyUnsafe(y,A=h.ZERO){if(!o.isValid(y))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return y===bt?h.ZERO:this.is0()||y===de?this:v.unsafe(this,y,w=>Ot(h,w),A)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return v.unsafe(this,s.n).is0()}toAffine(y){return m(this,y)}clearCofactor(){return i===de?this:this.multiplyUnsafe(i)}toBytes(){let{x:y,y:A}=this.toAffine(),w=n.toBytes(A);return w[w.length-1]|=y&de?128:0,w}toHex(){return nt(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let v=new ur(h,o.BITS);return h.BASE.precompute(8),h}function Nc(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');gt(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:o,Fp:s,Fn:i}=r,a=t.randomBytes||nr,c=t.adjustScalarBytes||(S=>S),u=t.domain||((S,E,N)=>{if(it(N,"phflag"),E.length||N)throw new Error("Contexts/pre-hash are not supported");return S});function l(S){return i.create(Lt(S))}function f(S){let E=w.secretKey;M(S,w.secretKey,"secretKey");let N=M(e(S),2*E,"hashedSecretKey"),V=c(N.slice(0,E)),L=N.slice(E,2*E),g=l(V);return{head:V,prefix:L,scalar:g}}function m(S){let{head:E,prefix:N,scalar:V}=f(S),L=o.multiply(V),g=L.toBytes();return{head:E,prefix:N,scalar:V,point:L,pointBytes:g}}function d(S){return m(S).pointBytes}function h(S=Uint8Array.of(),...E){let N=Ie(...E);return l(e(u(N,M(S,void 0,"context"),!!n)))}function v(S,E,N={}){S=M(S,void 0,"message"),n&&(S=n(S));let{prefix:V,scalar:L,pointBytes:g}=m(E),b=h(N.context,V,S),p=o.multiply(b).toBytes(),_=h(N.context,p,g,S),I=i.create(b+_*L);if(!i.isValid(I))throw new Error("sign failed: invalid s");let C=Ie(p,i.toBytes(I));return M(C,w.signature,"result")}let x={zip215:!0};function y(S,E,N,V=x){let{context:L,zip215:g}=V,b=w.signature;S=M(S,b,"signature"),E=M(E,void 0,"message"),N=M(N,w.publicKey,"publicKey"),g!==void 0&&it(g,"zip215"),n&&(E=n(E));let p=b/2,_=S.subarray(0,p),I=Lt(S.subarray(p,b)),C,R,D;try{C=r.fromBytes(N,g),R=r.fromBytes(_,g),D=o.multiplyUnsafe(I)}catch{return!1}if(!g&&C.isSmallOrder())return!1;let O=h(L,R.toBytes(),C.toBytes(),E);return R.add(C.multiplyUnsafe(O)).subtract(D).clearCofactor().is0()}let A=s.BYTES,w={secretKey:A,publicKey:A,signature:2*A,seed:A};function T(S=a(w.seed)){return M(S,w.seed,"seed")}function P(S){return It(S)&&S.length===i.BYTES}function k(S,E){try{return!!r.fromBytes(S,E)}catch{return!1}}let q={getExtendedPublicKey:m,randomSecretKey:T,isValidSecretKey:P,isValidPublicKey:k,toMontgomery(S){let{y:E}=r.fromBytes(S),N=w.publicKey,V=N===32;if(!V&&N!==57)throw new Error("only defined for 25519 and 448");let L=V?s.div(de+E,de-E):s.div(E-de,E+de);return s.toBytes(L)},toMontgomerySecret(S){let E=w.secretKey;M(S,E);let N=e(S.subarray(0,E));return c(N).subarray(0,E)}};return Object.freeze({keygen:Cn(T,d),getPublicKey:d,sign:v,verify:y,utils:q,Point:r,lengths:w})}var ch=BigInt(1),Uc=BigInt(2);var uh=BigInt(5),lh=BigInt(8),Ls=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),fh={p:Ls,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:lh,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function hh(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),o=BigInt(80),s=Ls,a=r*r%s*r%s,c=ee(a,Uc,s)*a%s,u=ee(c,ch,s)*r%s,l=ee(u,uh,s)*u%s,f=ee(l,e,s)*l%s,m=ee(f,t,s)*f%s,d=ee(m,n,s)*m%s,h=ee(d,o,s)*d%s,v=ee(h,o,s)*d%s,x=ee(v,e,s)*l%s;return{pow_p_5_8:ee(x,Uc,s)*r%s,b2:a}}function dh(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var Mc=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function ph(r,e){let t=Ls,n=ce(e*e*e,t),o=ce(n*n*e,t),s=hh(r*o).pow_p_5_8,i=ce(r*n*s,t),a=ce(e*i*i,t),c=i,u=ce(i*Mc,t),l=a===r,f=a===ce(-r,t),m=a===ce(-r*Mc,t);return l&&(i=c),(f||m)&&(i=u),Tc(i,t)&&(i=ce(-i,t)),{isValid:l||f,value:i}}var mh=Pc(fh,{uvRatio:ph});function yh(r){return Nc(mh,dc,Object.assign({adjustScalarBytes:dh},r))}var kc=yh({});var Fr=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},Ln=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Kc={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new Ln("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var Ne=Kc;var Rn=32;var Rs,gh=(async()=>{try{return await Ne.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function bh(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await Ne.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Ne.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function xh(r,e,t){return kc.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function qc(r,e,t){return Rs==null&&(Rs=await gh),Rs?bh(r,e,t):xh(r,e,t)}function Bn(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var On=class{type="Ed25519";raw;constructor(e){this.raw=Bs(e,Rn)}toMultihash(){return Me.digest($e(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return te.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:fe(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let o=qc(this.raw,t,e);return Bn(o)?o.then(s=>(n?.signal?.throwIfAborted(),s)):o}};function Os(r){return r=Bs(r,Rn),new On(r)}function Bs(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new ie(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var Eh=Math.pow(2,7),Sh=Math.pow(2,14),vh=Math.pow(2,21),Ps=Math.pow(2,28),Ns=Math.pow(2,35),Us=Math.pow(2,42),Ms=Math.pow(2,49),Z=128,xe=127;function De(r){if(r<Eh)return 1;if(r<Sh)return 2;if(r<vh)return 3;if(r<Ps)return 4;if(r<Ns)return 5;if(r<Us)return 6;if(r<Ms)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function lr(r,e,t=0){switch(De(r)){case 8:e[t++]=r&255|Z,r/=128;case 7:e[t++]=r&255|Z,r/=128;case 6:e[t++]=r&255|Z,r/=128;case 5:e[t++]=r&255|Z,r/=128;case 4:e[t++]=r&255|Z,r>>>=7;case 3:e[t++]=r&255|Z,r>>>=7;case 2:e[t++]=r&255|Z,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function _h(r,e,t=0){switch(De(r)){case 8:e.set(t++,r&255|Z),r/=128;case 7:e.set(t++,r&255|Z),r/=128;case 6:e.set(t++,r&255|Z),r/=128;case 5:e.set(t++,r&255|Z),r/=128;case 4:e.set(t++,r&255|Z),r>>>=7;case 3:e.set(t++,r&255|Z),r>>>=7;case 2:e.set(t++,r&255|Z),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function ks(r,e){let t=r[e],n=0;if(n+=t&xe,t<Z||(t=r[e+1],n+=(t&xe)<<7,t<Z)||(t=r[e+2],n+=(t&xe)<<14,t<Z)||(t=r[e+3],n+=(t&xe)<<21,t<Z)||(t=r[e+4],n+=(t&xe)*Ps,t<Z)||(t=r[e+5],n+=(t&xe)*Ns,t<Z)||(t=r[e+6],n+=(t&xe)*Us,t<Z)||(t=r[e+7],n+=(t&xe)*Ms,t<Z))return n;throw new RangeError("Could not decode varint")}function Ah(r,e){let t=r.get(e),n=0;if(n+=t&xe,t<Z||(t=r.get(e+1),n+=(t&xe)<<7,t<Z)||(t=r.get(e+2),n+=(t&xe)<<14,t<Z)||(t=r.get(e+3),n+=(t&xe)<<21,t<Z)||(t=r.get(e+4),n+=(t&xe)*Ps,t<Z)||(t=r.get(e+5),n+=(t&xe)*Ns,t<Z)||(t=r.get(e+6),n+=(t&xe)*Us,t<Z)||(t=r.get(e+7),n+=(t&xe)*Ms,t<Z))return n;throw new RangeError("Could not decode varint")}function fr(r,e,t=0){return e==null&&(e=Ae(De(r))),e instanceof Uint8Array?lr(r,e,t):_h(r,e,t)}function zr(r,e=0){return r instanceof Uint8Array?ks(r,e):Ah(r,e)}var qs=new Float32Array([-0]),xt=new Uint8Array(qs.buffer);function Hc(r,e,t){qs[0]=r,e[t]=xt[0],e[t+1]=xt[1],e[t+2]=xt[2],e[t+3]=xt[3]}function Fc(r,e){return xt[0]=r[e],xt[1]=r[e+1],xt[2]=r[e+2],xt[3]=r[e+3],qs[0]}var Vs=new Float64Array([-0]),we=new Uint8Array(Vs.buffer);function zc(r,e,t){Vs[0]=r,e[t]=we[0],e[t+1]=we[1],e[t+2]=we[2],e[t+3]=we[3],e[t+4]=we[4],e[t+5]=we[5],e[t+6]=we[6],e[t+7]=we[7]}function $c(r,e){return we[0]=r[e],we[1]=r[e+1],we[2]=r[e+2],we[3]=r[e+3],we[4]=r[e+4],we[5]=r[e+5],we[6]=r[e+6],we[7]=r[e+7],Vs[0]}var Th=BigInt(Number.MAX_SAFE_INTEGER),Ih=BigInt(Number.MIN_SAFE_INTEGER),Be=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Pt;if(e<Th&&e>Ih)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,o=e-(n<<32n);return t&&(n=~n|0n,o=~o|0n,++o>Wc&&(o=0n,++n>Wc&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(e){if(e===0)return Pt;let t=e<0;t&&(e=-e);let n=e>>>0,o=(e-n)/4294967296>>>0;return t&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Pt}},Pt=new Be(0,0);Pt.toBigInt=function(){return 0n};Pt.zzEncode=Pt.zzDecode=function(){return this};Pt.length=function(){return 1};var Wc=4294967296n;function Gc(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function Zc(r,e,t){if(t-e<1)return"";let o,s=[],i=0,a;for(;e<t;)a=r[e++],a<128?s[i++]=a:a>191&&a<224?s[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[i++]=55296+(a>>10),s[i++]=56320+(a&1023)):s[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,s)),i=0);return o!=null?(i>0&&o.push(String.fromCharCode.apply(String,s.slice(0,i))),o.join("")):String.fromCharCode.apply(String,s.slice(0,i))}function Hs(r,e,t){let n=t,o,s;for(let i=0;i<r.length;++i)o=r.charCodeAt(i),o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&((s=r.charCodeAt(i+1))&64512)===56320?(o=65536+((o&1023)<<10)+(s&1023),++i,e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128);return t-n}function Ke(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Pn(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var Fs=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Ke(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Ke(this,4);return Pn(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Ke(this,4);return Pn(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Ke(this,4);let e=Fc(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Ke(this,4);let e=$c(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Ke(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return Zc(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Ke(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Ke(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Be(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Ke(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Ke(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Ke(this,8);let e=Pn(this.buf,this.pos+=4),t=Pn(this.buf,this.pos+=4);return new Be(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=ks(this.buf,this.pos);return this.pos+=De(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function zs(r){return new Fs(r instanceof Uint8Array?r:r.subarray())}function Ce(r,e,t){let n=zs(r);return e.decode(n,void 0,t)}function $s(r){let e=r??8192,t=e>>>1,n,o=e;return function(i){if(i<1||i>t)return Ae(i);o+i>e&&(n=Ae(e),o=0);let a=n.subarray(o,o+=i);return(o&7)!==0&&(o=(o|7)+1),a}}var Nt=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function Ws(){}var Zs=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},Dh=$s();function Ch(r){return globalThis.Buffer!=null?Ae(r):Dh(r)}var Wr=class{len;head;tail;states;constructor(){this.len=0,this.head=new Nt(Ws,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Nt(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Ys((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Nn,10,Be.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Be.fromBigInt(e);return this._push(Nn,t.length(),t)}uint64Number(e){return this._push(lr,De(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Be.fromBigInt(e).zzEncode();return this._push(Nn,t.length(),t)}sint64Number(e){let t=Be.fromNumber(e).zzEncode();return this._push(Nn,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Gs,1,e?1:0)}fixed32(e){return this._push($r,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Be.fromBigInt(e);return this._push($r,4,t.lo)._push($r,4,t.hi)}fixed64Number(e){let t=Be.fromNumber(e);return this._push($r,4,t.lo)._push($r,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Hc,4,e)}double(e){return this._push(zc,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(Gs,1,0):this.uint32(t)._push(Rh,t,e)}string(e){let t=Gc(e);return t!==0?this.uint32(t)._push(Hs,t,e):this._push(Gs,1,0)}fork(){return this.states=new Zs(this),this.head=this.tail=new Nt(Ws,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Nt(Ws,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=Ch(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function Gs(r,e,t){e[t]=r&255}function Lh(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var Ys=class extends Nt{next;constructor(e,t){super(Lh,e,t),this.next=void 0}};function Nn(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function $r(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Rh(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Wr.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(Bh,e,r),this},Wr.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Oh,e,r),this});function Bh(r,e,t){e.set(r,t)}function Oh(r,e,t){r.length<40?Hs(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(K(r),t)}function Xs(){return new Wr}function Le(r,e){let t=Xs();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var hr;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(hr||(hr={}));function Un(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Ut(r){function e(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let t=function(s,i){let a=e(s);i.int32(a)},n=function(s){let i=s.int32();return e(i)};return Un("enum",hr.VARINT,t,n)}function Re(r,e){return Un("message",hr.LENGTH_DELIMITED,r,e)}var Gr=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"};var ue;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(ue||(ue={}));var js;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(js||(js={}));(function(r){r.codec=()=>Ut(js)})(ue||(ue={}));var Ze;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ue.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.Type=ue.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(Ze||(Ze={}));var Qs;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ue.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.Type=ue.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(Qs||(Qs={}));var Yr={};ve(Yr,{MAX_RSA_KEY_SIZE:()=>Js,generateRSAKeyPair:()=>eu,jwkToJWKKeyPair:()=>tu,jwkToPkcs1:()=>Mh,jwkToPkix:()=>ni,jwkToRSAPrivateKey:()=>ai,pkcs1MessageToJwk:()=>ti,pkcs1MessageToRSAPrivateKey:()=>oi,pkcs1ToJwk:()=>Uh,pkcs1ToRSAPrivateKey:()=>Jc,pkixMessageToJwk:()=>ri,pkixMessageToRSAPublicKey:()=>ii,pkixToJwk:()=>kh,pkixToRSAPublicKey:()=>si});var dr=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Yr.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return le.createV1(114,this._multihash)}toString(){return te.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:fe(this.raw,e.raw)}verify(e,t,n){return Qc(this.jwk,t,e,n)}},Zr=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Yr.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:fe(this.raw,e.raw)}sign(e,t){return jc(this.jwk,e,t)}};var Js=8192,ei=18,Ph=1062,Nh=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function Uh(r){let e=et(r);return ti(e)}function ti(r){return{n:$(r[1],"base64url"),e:$(r[2],"base64url"),d:$(r[3],"base64url"),p:$(r[4],"base64url"),q:$(r[5],"base64url"),dp:$(r[6],"base64url"),dq:$(r[7],"base64url"),qi:$(r[8],"base64url"),kty:"RSA"}}function Mh(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new ie("JWK was missing components");return dt([Te(Uint8Array.from([0])),Te(K(r.n,"base64url")),Te(K(r.e,"base64url")),Te(K(r.d,"base64url")),Te(K(r.p,"base64url")),Te(K(r.q,"base64url")),Te(K(r.dp,"base64url")),Te(K(r.dq,"base64url")),Te(K(r.qi,"base64url"))]).subarray()}function kh(r){let e=et(r,{offset:0});return ri(e)}function ri(r){let e=et(r[1],{offset:0});return{kty:"RSA",n:$(e[0],"base64url"),e:$(e[1],"base64url")}}function ni(r){if(r.n==null||r.e==null)throw new ie("JWK was missing components");return dt([Nh,En(dt([Te(K(r.n,"base64url")),Te(K(r.e,"base64url"))]))]).subarray()}function Jc(r){let e=et(r);return oi(e)}function oi(r){let e=ti(r);return ai(e)}function si(r,e){if(r.byteLength>=Ph)throw new Gt("Key size is too large");let t=et(r,{offset:0});return ii(t,r,e)}function ii(r,e,t){let n=ri(r);if(t==null){let o=or(Ze.encode({Type:ue.RSA,Data:e}));t=Fe(ei,o)}return new dr(n,t)}function ai(r){if(nu(r)>Js)throw new ie("Key size is too large");let e=tu(r),t=or(Ze.encode({Type:ue.RSA,Data:ni(e.publicKey)})),n=Fe(ei,t);return new Zr(e.privateKey,new dr(e.publicKey,n))}async function eu(r){if(r>Js)throw new ie("Key size is too large");let e=await ru(r),t=or(Ze.encode({Type:ue.RSA,Data:ni(e.publicKey)})),n=Fe(ei,t);return new Zr(e.privateKey,new dr(e.publicKey,n))}function tu(r){if(r==null)throw new ie("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function ru(r,e){let t=await Ne.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await Kh(t,e);return{privateKey:n[0],publicKey:n[1]}}async function jc(r,e,t){let n=await Ne.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let o=await Ne.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function Qc(r,e,t,n){let o=await Ne.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let s=await Ne.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),s}async function Kh(r,e){if(r.privateKey==null||r.publicKey==null)throw new ie("Private and public key are required");let t=await Promise.all([Ne.get().subtle.exportKey("jwk",r.privateKey),Ne.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function nu(r){if(r.kty!=="RSA")throw new ie("invalid key type");if(r.n==null)throw new ie("invalid key modulus");return K(r.n,"base64url").length*8}var Mn=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(Sn(e),M(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,o=new Uint8Array(n);o.set(t.length>n?e.create().update(t).digest():t);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=e.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),rt(o)}update(e){return rr(this),this.iHash.update(e),this}digestInto(e){rr(this),M(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});let{oHash:t,iHash:n,finished:o,destroyed:s,blockLen:i,outputLen:a}=this;return e=e,e.finished=o,e.destroyed=s,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ci=(r,e,t)=>new Mn(r,e).update(t).digest();ci.create=(r,e)=>new Mn(r,e);var ou=(r,e)=>(r+(r>=0?e:-e)/su)/e;function qh(r,e,t){let[[n,o],[s,i]]=e,a=ou(i*r,t),c=ou(-o*r,t),u=r-a*n-c*s,l=-a*o-c*i,f=u<at,m=l<at;f&&(u=-u),m&&(l=-l);let d=qr(Math.ceil(ws(t)/2))+pr;if(u<at||u>=d||l<at||l>=d)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:u,k2neg:m,k2:l}}function li(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function ui(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return it(t.lowS,"lowS"),it(t.prehash,"prehash"),t.format!==void 0&&li(t.format),t}var fi=class extends Error{constructor(e=""){super(e)}},wt={Err:fi,_tlv:{encode:(r,e)=>{let{Err:t}=wt;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,o=kr(n);if(o.length/2&128)throw new t("tlv.encode: long form length too big");let s=n>127?kr(o.length/2|128):"";return kr(r)+s+o+e},decode(r,e){let{Err:t}=wt,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let o=e[n++],s=!!(o&128),i=0;if(!s)i=o;else{let c=o&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let l of u)i=i<<8|l;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=wt;if(r<at)throw new e("integer: negative integers are not allowed");let t=kr(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=wt;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return sr(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=wt,o=M(r,void 0,"signature"),{v:s,l:i}=n.decode(48,o);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,s),{v:u,l}=n.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=wt,n=e.encode(2,t.encode(r.r)),o=e.encode(2,t.encode(r.s)),s=n+o;return e.encode(48,s)}},at=BigInt(0),pr=BigInt(1),su=BigInt(2),kn=BigInt(3),Vh=BigInt(4);function iu(r,e={}){let t=Dn("weierstrass",r,e),{Fp:n,Fn:o}=t,s=t.CURVE,{h:i,n:a}=s;gt(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(s.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=cu(n,o);function l(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(L,g,b){let{x:p,y:_}=g.toAffine(),I=n.toBytes(p);if(it(b,"isCompressed"),b){l();let C=!n.isOdd(_);return Ie(au(C),I)}else return Ie(Uint8Array.of(4),I,n.toBytes(_))}function m(L){M(L,void 0,"Point");let{publicKey:g,publicKeyUncompressed:b}=u,p=L.length,_=L[0],I=L.subarray(1);if(p===g&&(_===2||_===3)){let C=n.fromBytes(I);if(!n.isValid(C))throw new Error("bad point: is not on curve, wrong x");let R=v(C),D;try{D=n.sqrt(R)}catch(ne){let Q=ne instanceof Error?": "+ne.message:"";throw new Error("bad point: is not on curve, sqrt error"+Q)}l();let O=n.isOdd(D);return(_&1)===1!==O&&(D=n.neg(D)),{x:C,y:D}}else if(p===b&&_===4){let C=n.BYTES,R=n.fromBytes(I.subarray(0,C)),D=n.fromBytes(I.subarray(C,C*2));if(!x(R,D))throw new Error("bad point: is not on curve");return{x:R,y:D}}else throw new Error(`bad point: got length ${p}, expected compressed=${g} or uncompressed=${b}`)}let d=e.toBytes||f,h=e.fromBytes||m;function v(L){let g=n.sqr(L),b=n.mul(g,L);return n.add(n.add(b,n.mul(L,s.a)),s.b)}function x(L,g){let b=n.sqr(g),p=v(L);return n.eql(b,p)}if(!x(s.Gx,s.Gy))throw new Error("bad curve params: generator point");let y=n.mul(n.pow(s.a,kn),Vh),A=n.mul(n.sqr(s.b),BigInt(27));if(n.is0(n.add(y,A)))throw new Error("bad curve params: a or b");function w(L,g,b=!1){if(!n.isValid(g)||b&&n.is0(g))throw new Error(`bad point coordinate ${L}`);return g}function T(L){if(!(L instanceof E))throw new Error("Weierstrass Point expected")}function P(L){if(!c||!c.basises)throw new Error("no endo");return qh(L,c.basises,o.ORDER)}let k=ir((L,g)=>{let{X:b,Y:p,Z:_}=L;if(n.eql(_,n.ONE))return{x:b,y:p};let I=L.is0();g==null&&(g=I?n.ONE:n.inv(_));let C=n.mul(b,g),R=n.mul(p,g),D=n.mul(_,g);if(I)return{x:n.ZERO,y:n.ZERO};if(!n.eql(D,n.ONE))throw new Error("invZ was invalid");return{x:C,y:R}}),q=ir(L=>{if(L.is0()){if(e.allowInfinityPoint&&!n.is0(L.Y))return;throw new Error("bad point: ZERO")}let{x:g,y:b}=L.toAffine();if(!n.isValid(g)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!x(g,b))throw new Error("bad point: equation left != right");if(!L.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function S(L,g,b,p,_){return b=new E(n.mul(b.X,L),b.Y,b.Z),g=Hr(p,g),b=Hr(_,b),g.add(b)}class E{static BASE=new E(s.Gx,s.Gy,n.ONE);static ZERO=new E(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=o;X;Y;Z;constructor(g,b,p){this.X=w("x",g),this.Y=w("y",b,!0),this.Z=w("z",p),Object.freeze(this)}static CURVE(){return s}static fromAffine(g){let{x:b,y:p}=g||{};if(!g||!n.isValid(b)||!n.isValid(p))throw new Error("invalid affine point");if(g instanceof E)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(p)?E.ZERO:new E(b,p,n.ONE)}static fromBytes(g){let b=E.fromAffine(h(M(g,void 0,"point")));return b.assertValidity(),b}static fromHex(g){return E.fromBytes(ot(g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,b=!0){return V.createCache(this,g),b||this.multiply(kn),this}assertValidity(){q(this)}hasEvenY(){let{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){T(g);let{X:b,Y:p,Z:_}=this,{X:I,Y:C,Z:R}=g,D=n.eql(n.mul(b,R),n.mul(I,_)),O=n.eql(n.mul(p,R),n.mul(C,_));return D&&O}negate(){return new E(this.X,n.neg(this.Y),this.Z)}double(){let{a:g,b}=s,p=n.mul(b,kn),{X:_,Y:I,Z:C}=this,R=n.ZERO,D=n.ZERO,O=n.ZERO,U=n.mul(_,_),ne=n.mul(I,I),Q=n.mul(C,C),W=n.mul(_,I);return W=n.add(W,W),O=n.mul(_,C),O=n.add(O,O),R=n.mul(g,O),D=n.mul(p,Q),D=n.add(R,D),R=n.sub(ne,D),D=n.add(ne,D),D=n.mul(R,D),R=n.mul(W,R),O=n.mul(p,O),Q=n.mul(g,Q),W=n.sub(U,Q),W=n.mul(g,W),W=n.add(W,O),O=n.add(U,U),U=n.add(O,U),U=n.add(U,Q),U=n.mul(U,W),D=n.add(D,U),Q=n.mul(I,C),Q=n.add(Q,Q),U=n.mul(Q,W),R=n.sub(R,U),O=n.mul(Q,ne),O=n.add(O,O),O=n.add(O,O),new E(R,D,O)}add(g){T(g);let{X:b,Y:p,Z:_}=this,{X:I,Y:C,Z:R}=g,D=n.ZERO,O=n.ZERO,U=n.ZERO,ne=s.a,Q=n.mul(s.b,kn),W=n.mul(b,I),oe=n.mul(p,C),me=n.mul(_,R),He=n.add(b,p),se=n.add(I,C);He=n.mul(He,se),se=n.add(W,oe),He=n.sub(He,se),se=n.add(b,_);let be=n.add(I,R);return se=n.mul(se,be),be=n.add(W,me),se=n.sub(se,be),be=n.add(p,_),D=n.add(C,R),be=n.mul(be,D),D=n.add(oe,me),be=n.sub(be,D),U=n.mul(ne,se),D=n.mul(Q,me),U=n.add(D,U),D=n.sub(oe,U),U=n.add(oe,U),O=n.mul(D,U),oe=n.add(W,W),oe=n.add(oe,W),me=n.mul(ne,me),se=n.mul(Q,se),oe=n.add(oe,me),me=n.sub(W,me),me=n.mul(ne,me),se=n.add(se,me),W=n.mul(oe,se),O=n.add(O,W),W=n.mul(be,se),D=n.mul(He,D),D=n.sub(D,W),W=n.mul(He,oe),U=n.mul(be,U),U=n.add(U,W),new E(D,O,U)}subtract(g){return this.add(g.negate())}is0(){return this.equals(E.ZERO)}multiply(g){let{endo:b}=e;if(!o.isValidNot0(g))throw new Error("invalid scalar: out of range");let p,_,I=C=>V.cached(this,C,R=>Ot(E,R));if(b){let{k1neg:C,k1:R,k2neg:D,k2:O}=P(g),{p:U,f:ne}=I(R),{p:Q,f:W}=I(O);_=ne.add(W),p=S(b.beta,U,Q,C,D)}else{let{p:C,f:R}=I(g);p=C,_=R}return Ot(E,[p,_])[0]}multiplyUnsafe(g){let{endo:b}=e,p=this;if(!o.isValid(g))throw new Error("invalid scalar: out of range");if(g===at||p.is0())return E.ZERO;if(g===pr)return p;if(V.hasCache(this))return this.multiply(g);if(b){let{k1neg:_,k1:I,k2neg:C,k2:R}=P(g),{p1:D,p2:O}=Oc(E,p,I,R);return S(b.beta,D,O,_,C)}else return V.unsafe(p,g)}toAffine(g){return k(this,g)}isTorsionFree(){let{isTorsionFree:g}=e;return i===pr?!0:g?g(E,this):V.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:g}=e;return i===pr?this:g?g(E,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return it(g,"isCompressed"),this.assertValidity(),d(E,this,g)}toHex(g=!0){return nt(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let N=o.BITS,V=new ur(E,e.endo?Math.ceil(N/2):N);return E.BASE.precompute(8),E}function au(r){return Uint8Array.of(r?2:3)}function cu(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Hh(r,e={}){let{Fn:t}=r,n=e.randomBytes||nr,o=Object.assign(cu(r.Fp,t),{seed:_s(t.ORDER)});function s(d){try{let h=t.fromBytes(d);return t.isValidNot0(h)}catch{return!1}}function i(d,h){let{publicKey:v,publicKeyUncompressed:x}=o;try{let y=d.length;return h===!0&&y!==v||h===!1&&y!==x?!1:!!r.fromBytes(d)}catch{return!1}}function a(d=n(o.seed)){return As(M(d,o.seed,"seed"),t.ORDER)}function c(d,h=!0){return r.BASE.multiply(t.fromBytes(d)).toBytes(h)}function u(d){let{secretKey:h,publicKey:v,publicKeyUncompressed:x}=o;if(!It(d)||"_lengths"in t&&t._lengths||h===v)return;let y=M(d,void 0,"key").length;return y===v||y===x}function l(d,h,v=!0){if(u(d)===!0)throw new Error("first arg must be private key");if(u(h)===!1)throw new Error("second arg must be public key");let x=t.fromBytes(d);return r.fromBytes(h).multiply(x).toBytes(v)}let f={isValidSecretKey:s,isValidPublicKey:i,randomSecretKey:a},m=Cn(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:l,keygen:m,Point:r,utils:f,lengths:o})}function uu(r,e,t={}){Sn(e),gt(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||nr,o=t.hmac||((b,p)=>ci(e,b,p)),{Fp:s,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:l,getSharedSecret:f,utils:m,lengths:d}=Hh(r,t),h={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},v=a*su<s.ORDER;function x(b){let p=a>>pr;return b>p}function y(b,p){if(!i.isValidNot0(p))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return p}function A(){if(v)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(b,p){li(p);let _=d.signature,I=p==="compact"?_:p==="recovered"?_+1:void 0;return M(b,I)}class T{r;s;recovery;constructor(p,_,I){if(this.r=y("r",p),this.s=y("s",_),I!=null){if(A(),![0,1,2,3].includes(I))throw new Error("invalid recovery id");this.recovery=I}Object.freeze(this)}static fromBytes(p,_=h.format){w(p,_);let I;if(_==="der"){let{r:O,s:U}=wt.toSig(M(p));return new T(O,U)}_==="recovered"&&(I=p[0],_="compact",p=p.subarray(1));let C=d.signature/2,R=p.subarray(0,C),D=p.subarray(C,C*2);return new T(i.fromBytes(R),i.fromBytes(D),I)}static fromHex(p,_){return this.fromBytes(ot(p),_)}assertRecovery(){let{recovery:p}=this;if(p==null)throw new Error("invalid recovery id: must be present");return p}addRecoveryBit(p){return new T(this.r,this.s,p)}recoverPublicKey(p){let{r:_,s:I}=this,C=this.assertRecovery(),R=C===2||C===3?_+a:_;if(!s.isValid(R))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let D=s.toBytes(R),O=r.fromBytes(Ie(au((C&1)===0),D)),U=i.inv(R),ne=k(M(p,void 0,"msgHash")),Q=i.create(-ne*U),W=i.create(I*U),oe=r.BASE.multiplyUnsafe(Q).add(O.multiplyUnsafe(W));if(oe.is0())throw new Error("invalid recovery: point at infinify");return oe.assertValidity(),oe}hasHighS(){return x(this.s)}toBytes(p=h.format){if(li(p),p==="der")return ot(wt.hexFromSig(this));let{r:_,s:I}=this,C=i.toBytes(_),R=i.toBytes(I);return p==="recovered"?(A(),Ie(Uint8Array.of(this.assertRecovery()),C,R)):Ie(C,R)}toHex(p){return nt(this.toBytes(p))}}let P=t.bits2int||function(p){if(p.length>8192)throw new Error("input is too large");let _=sr(p),I=p.length*8-c;return I>0?_>>BigInt(I):_},k=t.bits2int_modN||function(p){return i.create(P(p))},q=qr(c);function S(b){return Kr("num < 2^"+c,b,at,q),i.toBytes(b)}function E(b,p){return M(b,void 0,"message"),p?M(e(b),void 0,"prehashed message"):b}function N(b,p,_){let{lowS:I,prehash:C,extraEntropy:R}=ui(_,h);b=E(b,C);let D=k(b),O=i.fromBytes(p);if(!i.isValidNot0(O))throw new Error("invalid private key");let U=[S(O),S(D)];if(R!=null&&R!==!1){let oe=R===!0?n(d.secretKey):R;U.push(M(oe,void 0,"extraEntropy"))}let ne=Ie(...U),Q=D;function W(oe){let me=P(oe);if(!i.isValidNot0(me))return;let He=i.inv(me),se=r.BASE.multiply(me).toAffine(),be=i.create(se.x);if(be===at)return;let un=i.create(He*i.create(Q+be*O));if(un===at)return;let ya=(se.x===be?0:2)|Number(se.y&pr),ga=un;return I&&x(un)&&(ga=i.neg(un),ya^=1),new T(be,ga,v?void 0:ya)}return{seed:ne,k2sig:W}}function V(b,p,_={}){let{seed:I,k2sig:C}=N(b,p,_);return yc(e.outputLen,i.BYTES,o)(I,C).toBytes(_.format)}function L(b,p,_,I={}){let{lowS:C,prehash:R,format:D}=ui(I,h);if(_=M(_,void 0,"publicKey"),p=E(p,R),!It(b)){let O=b instanceof T?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+O)}w(b,D);try{let O=T.fromBytes(b,D),U=r.fromBytes(_);if(C&&O.hasHighS())return!1;let{r:ne,s:Q}=O,W=k(p),oe=i.inv(Q),me=i.create(W*oe),He=i.create(ne*oe),se=r.BASE.multiplyUnsafe(me).add(U.multiplyUnsafe(He));return se.is0()?!1:i.create(se.x)===ne}catch{return!1}}function g(b,p,_={}){let{prehash:I}=ui(_,h);return p=E(p,I),T.fromBytes(b,"recovered").recoverPublicKey(p).toBytes()}return Object.freeze({keygen:u,getPublicKey:l,getSharedSecret:f,utils:m,lengths:d,Point:r,sign:V,verify:L,recoverPublicKey:g,Signature:T,hash:e})}var di={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Fh={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var lu=BigInt(2);function zh(r){let e=di.p,t=BigInt(3),n=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,l=u*u*r%e,f=ee(l,t,e)*l%e,m=ee(f,t,e)*l%e,d=ee(m,lu,e)*u%e,h=ee(d,o,e)*d%e,v=ee(h,s,e)*h%e,x=ee(v,a,e)*v%e,y=ee(x,c,e)*x%e,A=ee(y,a,e)*v%e,w=ee(A,t,e)*l%e,T=ee(w,i,e)*h%e,P=ee(T,n,e)*u%e,k=ee(P,lu,e);if(!hi.eql(hi.sqr(k),r))throw new Error("Cannot find square root");return k}var hi=ar(di.p,{sqrt:zh}),$h=iu(di,{Fp:hi,endo:Fh}),mr=uu($h,or);function fu(r,e,t,n){let o=er.digest(t instanceof Uint8Array?t:t.subarray());if(Bn(o))return o.then(({digest:s})=>(n?.signal?.throwIfAborted(),mr.verify(e,s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new Fr(String(s))});try{return n?.signal?.throwIfAborted(),mr.verify(e,o.digest,r,{prehash:!1,format:"der"})}catch(s){throw new Fr(String(s))}}var Kn=class{type="secp256k1";raw;_key;constructor(e){this._key=du(e),this.raw=hu(this._key)}toMultihash(){return Me.digest($e(this))}toCID(){return le.createV1(114,this.toMultihash())}toString(){return te.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:fe(this.raw,e.raw)}verify(e,t,n){return fu(this._key,t,e,n)}};function pi(r){return new Kn(r)}function hu(r){return mr.Point.fromBytes(r).toBytes()}function du(r){try{return mr.Point.fromBytes(r),r}catch(e){throw new Gt(String(e))}}function pu(r,e){let{Type:t,Data:n}=Ze.decode(r),o=n??new Uint8Array;switch(t){case ue.RSA:return si(o,e);case ue.Ed25519:return Os(o);case ue.secp256k1:return pi(o);case ue.ECDSA:return cs(o);default:throw new Zt}}function mu(r){let{Type:e,Data:t}=Ze.decode(r.digest),n=t??new Uint8Array;switch(e){case ue.Ed25519:return Os(n);case ue.secp256k1:return pi(n);case ue.ECDSA:return cs(n);default:throw new Zt}}function $e(r){return Ze.encode({Type:ue[r.type],Data:r.raw})}var yu=Symbol.for("nodejs.util.inspect.custom"),Wh=114,Xr=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Po]=!0;toString(){return this.string==null&&(this.string=te.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return le.createV1(Wh,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return fe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return fe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[yu](){return`PeerId(${this.toString()})`}},qn=class extends Xr{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Vn=class extends Xr{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},Hn=class extends Xr{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},Gh=2336,jr=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Me.digest(K(this.url))}[yu](){return`PeerId(${this.url})`}[Po]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return le.createV1(Gh,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=$(e)),e.toString()===this.toString())}};var Zh=114,gu=2336;function mi(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=ze(te.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Yh(le.parse(r));if(e==null)throw new ie('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=ze(e.decode(r))}return yr(t)}function yr(r){if(jh(r))return new qn({multihash:r});if(Xh(r))try{let e=mu(r);if(e.type==="Ed25519")return new Vn({multihash:r,publicKey:e});if(e.type==="secp256k1")return new Hn({multihash:r,publicKey:e})}catch{let t=$(r.digest);return new jr(new URL(t))}throw new hn("Supplied PeerID Multihash is invalid")}function Yh(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==Zh&&r.code!==gu)throw new fn("Supplied PeerID CID is invalid");if(r.code===gu){let e=$(r.multihash.digest);return new jr(new URL(e))}return yr(r.multihash)}function Xh(r){return r.code===Me.code}function jh(r){return r.code===er.code}var Qr;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={publicKey:re(0),payloadType:re(0),payload:re(0),signature:re(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(Qr||(Qr={}));var Fn=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var Jr=class r{static createFromProtobuf=e=>{let t=Qr.decode(e),n=pu(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let o=e.domain,s=e.codec,i=e.marshal(),a=bu(o,s,i),c=await t.sign(a.subarray(),n);return new r({publicKey:t.publicKey,payloadType:s,payload:i,signature:c})};static openAndCertify=async(e,t,n)=>{let o=r.createFromProtobuf(e);if(!await o.validate(t,n))throw new Fn("Envelope signature is not valid for the given domain");return o};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:o,signature:s}=e;this.publicKey=t,this.payloadType=n,this.payload=o,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=Qr.encode({publicKey:$e(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:fe(this.marshal(),e.marshal())}async validate(e,t){let n=bu(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}},bu=(r,e,t)=>{let n=K(r),o=fr(n.byteLength),s=fr(e.length),i=fr(t.length);return new J(o,n,s,e,i,t)};var ge=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},ct=class extends Error{static name="ValidationError";name="ValidationError"},zn=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},$n=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};var Wn=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,o){return this.readAtomically(()=>{let s=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",u=2**(8*o)-1;for(;;){let l=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let m=Number.parseInt(f,e);if(!Number.isNaN(m))return m});if(l===void 0)break;if(s*=e,s+=l,s>u||(i+=1,t!==void 0&&i>t))return}if(i!==0)return!n&&c&&i>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let o=n*2;if(n<t.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return t[o]=i[0],t[o+1]=i[1],t[o+2]=i[2],t[o+3]=i[3],[o+4,!0]}let s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[o,!1];t[o]=s>>8,t[o+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,o]=e(t);if(n===16)return t;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let s=new Uint8Array(14),i=16-(n+2),[a]=e(s.subarray(0,i));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var Qh=45,Jh=15,Gn=new Wn;function xu(r){if(!(r.length>Jh))return Gn.new(r).parseWith(()=>Gn.readIPv4Addr())}function wu(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Qh))return Gn.new(r).parseWith(()=>Gn.readIPv6Addr())}function Zn(r){return!!xu(r)}function Eu(r){return!!wu(r)}function gi(r){return e=>$(e,r)}function bi(r){return e=>K(e,r)}function gr(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Mt(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function Su(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=K(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Mt(n);return Je([t,o],t.length+o.length)}function vu(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=ht.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Mt(n);return Je([t,o],t.length+o.length)}function xi(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=$(e,"base32"),o=gr(t);return`${n}:${o}`}var wi=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let o=parseInt(t,10);if(isNaN(o)||o<0||o>255)throw new ge("Invalid byte value in IP address");e[n]=o}),e},_u=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let s=Zn(t[n]),i;s&&(i=wi(t[n]),t[n]=$(i.subarray(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,$(i.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}let o=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let s=parseInt(t[n],16);if(isNaN(s)||s<0||s>65535)throw new ge("Invalid byte value in IP address");o[e++]=s>>8&255,o[e++]=s&255}return o},Au=function(r){if(r.byteLength!==4)throw new ge("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},Tu=function(r){if(r.byteLength!==16)throw new ge("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let o=r[n],s=r[n+1],i=`${o.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;e.push(i)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new ge(`Invalid IPv6 address "${t}"`)}};function Iu(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new ge(`Invalid IPv6 address "${r}"`)}}var yi=Object.values(Br).map(r=>r.decoder),ed=(function(){let r=yi[0].or(yi[1]);return yi.slice(2).forEach(e=>r=r.or(e)),r})();function Du(r){return ed.decode(r)}function Cu(r){return e=>r.encoder.encode(e)}function td(r){if(parseInt(r).toString()!==r)throw new ct("Value must be an integer")}function rd(r){if(r<0)throw new ct("Value must be a positive integer, or zero")}function nd(r){return e=>{if(e>r)throw new ct(`Value must be smaller than or equal to ${r}`)}}function od(...r){return e=>{for(let t of r)t(e)}}var en=od(td,rd,nd(65535));var pe=-1,Ei=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new $n(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},ut=new Ei,xd=[{code:4,name:"ip4",size:32,valueToBytes:wi,bytesToValue:Au,validate:r=>{if(!Zn(r))throw new ct(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Mt,bytesToValue:gr,validate:en},{code:273,name:"udp",size:16,valueToBytes:Mt,bytesToValue:gr,validate:en},{code:33,name:"dccp",size:16,valueToBytes:Mt,bytesToValue:gr,validate:en},{code:41,name:"ip6",size:128,valueToBytes:_u,bytesToValue:Tu,stringToValue:Iu,validate:r=>{if(!Eu(r))throw new ct(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:pe},{code:43,name:"ipcidr",size:8,bytesToValue:gi("base10"),valueToBytes:bi("base10")},{code:53,name:"dns",size:pe},{code:54,name:"dns4",size:pe},{code:55,name:"dns6",size:pe},{code:56,name:"dnsaddr",size:pe},{code:132,name:"sctp",size:16,valueToBytes:Mt,bytesToValue:gr,validate:en},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:pe,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:pe,bytesToValue:gi("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?bi("base58btc")(r):le.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:xi,valueToBytes:Su},{code:445,name:"onion3",size:296,bytesToValue:xi,valueToBytes:vu},{code:446,name:"garlic64",size:pe},{code:447,name:"garlic32",size:pe},{code:448,name:"tls"},{code:449,name:"sni",size:pe},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:pe,bytesToValue:Cu(Yo),valueToBytes:Du},{code:480,name:"http"},{code:481,name:"http-path",size:pe,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:pe}];xd.forEach(r=>{ut.addProtocol(r)});function Lu(r){let e=[],t=0;for(;t<r.length;){let n=zr(r,t),o=ut.getProtocol(n),s=De(n),i=wd(o,r,t+s),a=0;i>0&&o.size===pe&&(a=De(i));let c=s+a+i,u={code:n,name:o.name,bytes:r.subarray(t,t+c)};if(i>0){let l=t+s+a,f=r.subarray(l,l+i);u.value=o.bytesToValue?.(f)??$(f)}e.push(u),t+=c}return e}function Ru(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let o=ut.getProtocol(n.code),s=De(n.code),i,a=0,c=0;n.value!=null&&(i=o.valueToBytes?.(n.value)??K(n.value),a=i.byteLength,o.size===pe&&(c=De(a)));let u=new Uint8Array(s+c+a),l=0;lr(n.code,u,l),l+=s,i!=null&&(o.size===pe&&(lr(a,u,l),l+=c),u.set(i,l)),n.bytes=u}t.push(n.bytes),e+=n.bytes.byteLength}return Je(t,e)}function Bu(r){if(r.charAt(0)!=="/")throw new ge('String multiaddr must start with "/"');let e=[],t="protocol",n="",o="";for(let s=1;s<r.length;s++){let i=r.charAt(s);i!=="/"&&(t==="protocol"?o+=r.charAt(s):n+=r.charAt(s));let a=s===r.length-1;if(i==="/"||a){let c=ut.getProtocol(o);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",o="",t="protocol";continue}else if(a)throw new ge(`Component ${o} was missing value`);t="value"}else if(t==="value"){let u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new ge(`Component ${o} was missing value`);u.value=c.stringToValue?.(n)??n}e.push(u),n="",o="",t="protocol"}}}if(o!==""&&n!=="")throw new ge("Incomplete multiaddr");return e}function Ou(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=ut.getProtocol(e.code);if(t==null)throw new ge(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function wd(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:zr(e,t)}var Ed=Symbol.for("nodejs.util.inspect.custom"),ki=Symbol.for("@multiformats/multiaddr");function Sd(r){if(r==null&&(r="/"),Pu(r))return r.getComponents();if(r instanceof Uint8Array)return Lu(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),Bu(r);if(Array.isArray(r))return r;throw new ge("Must be a string, Uint8Array, Component[], or another Multiaddr")}var Qn=class r{[ki]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=Sd(e),t.validate!==!1&&vd(this)}get bytes(){return this.#r==null&&(this.#r=Ru(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=Ou(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),o=n.lastIndexOf(t);if(o<0)throw new zn(`Address ${this.toString()} does not contain subaddress: ${t}`);return new r(n.slice(0,o),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}equals(e){return fe(this.bytes,e.bytes)}[Ed](){return`Multiaddr(${this.toString()})`}};function vd(r){r.getComponents().forEach(e=>{let t=ut.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function Pu(r){return!!r?.[ki]}function Oe(r){return new Qn(r)}var Ki={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Nu={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Uu=new globalThis.TextEncoder;function _d(r,e){let t=Ki[e],n=Nu[e];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(e,n*t);return n}function Ad(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=Ki[e],o=Nu[e],s=r;for(;s.length>0;){let i=Uu.encodeInto(s,t);s=s.slice(i.read);for(let a=0;a<i.written;a++)o^=BigInt(t[a]),o=BigInt.asUintN(e,o*n)}return o}function qi(r,{size:e=32,utf8Buffer:t}={}){if(!Ki[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return Ad(r,e,t);r=Uu.encode(r)}return _d(r,e)}var tn={hash:r=>Number(qi(r,{size:32})),hashV:(r,e)=>Td(tn.hash(r,e))};function Td(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),K(e,"base16")}var Vi=64,qe=class{fp;h;seed;constructor(e,t,n,o=2){if(o>Vi)throw new TypeError("Invalid Fingerprint Size");let s=t.hashV(e,n),i=re(o);for(let a=0;a<i.length;a++)i[a]=s[a];i.length===0&&(i[0]=7),this.fp=i,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?fe(this.fp,e.fp):!1}};function Vt(r,e){return Math.floor(Math.random()*(e-r))+r}var Ht=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof qe))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof qe))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof qe))throw new TypeError("Invalid Fingerprint");let t=Vt(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof qe))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var Id=500,rn=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??tn,this.seed=e.seed??Vt(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=K(e));let t=new qe(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Ht(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new Ht(this.bucketSize)),this.buckets[n].add(t)||this.buckets[o].add(t))return this.count++,!0;let s=[n,o],i=s[Vt(0,s.length-1)];this.buckets[i]==null&&(this.buckets[i]=new Ht(this.bucketSize));for(let a=0;a<Id;a++){let c=this.buckets[i].swap(t);if(c!=null&&(i=(i^c.hash())%this.filterSize,this.buckets[i]==null&&(this.buckets[i]=new Ht(this.bucketSize)),this.buckets[i].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=K(e));let t=new qe(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.has(t)??!1;if(o)return o;let s=(n^t.hash())%this.filterSize;return this.buckets[s]?.has(t)??!1}remove(e){typeof e=="string"&&(e=K(e));let t=new qe(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.remove(t)??!1;if(o)return this.count--,o;let s=(n^t.hash())%this.filterSize,i=this.buckets[s]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},Dd={1:.5,2:.84,4:.95,8:.98};function Cd(r=.001){return r>.002?2:r>1e-5?4:8}function Mu(r,e=.001){let t=Cd(e),n=Dd[t],o=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),Vi);return{filterSize:o,bucketSize:t,fingerprintSize:s}}var Jn=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??tn,this.seed=e.seed??Vt(0,Math.pow(2,10)),this.filterSeries=[new rn({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=K(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new rn({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=K(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=K(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Er(r,e=.001,t){return new Jn({...Mu(r,e),...t??{}})}function Ve(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var eo=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Sr=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new eo(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new eo(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var Hi=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Et(r={}){return Ld(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Ld(r,e){e=e??{};let t=e.onEnd,n=new Sr,o,s,i,a=Ve(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((x,y)=>{s=A=>{s=null,n.push(A);try{x(r(n))}catch(w){y(w)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Ve()})}},u=x=>s!=null?s(x):(n.push(x),o),l=x=>(n=new Sr,s!=null?s({error:x}):(n.push({error:x}),o)),f=x=>{if(i)return o;if(e?.objectMode!==!0&&x?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:x})},m=x=>i?o:(i=!0,x!=null?l(x):u({done:!0})),d=()=>(n=new Sr,m(),{done:!0}),h=x=>(m(x),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:d,throw:h,push:f,end:m,get readableLength(){return n.size},onEmpty:async x=>{let y=x?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let A,w;y!=null&&(A=new Promise((T,P)=>{w=()=>{P(new Hi)},y.addEventListener("abort",w)}));try{await Promise.race([a.promise,A])}finally{w!=null&&y!=null&&y?.removeEventListener("abort",w)}}},t==null)return o;let v=o;return o={[Symbol.asyncIterator](){return this},next(){return v.next()},throw(x){return v.throw(x),t!=null&&(t(x),t=void 0),{done:!0}},return(){return v.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(x){return v.end(x),t!=null&&(t(x),t=void 0),o},get readableLength(){return v.readableLength},onEmpty:x=>v.onEmpty(x)},o}var Fi=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},zi=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},ku=r=>globalThis.DOMException===void 0?new zi(r):new DOMException(r),Ku=r=>{let e=r.reason===void 0?ku("This operation was aborted."):r.reason;return e instanceof Error?e:ku(e)};function $i(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:s={setTimeout,clearTimeout}}=e,i,a,u=new Promise((l,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:d}=e;d.aborted&&f(Ku(d)),a=()=>{f(Ku(d))},d.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(l,f);return}let m=new Fi;i=s.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(d){f(d)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?l():o instanceof Error?f(o):(m.message=o??`Promise timed out after ${t} milliseconds`,f(m))},t),(async()=>{try{l(await r)}catch(d){f(d)}})()}).finally(()=>{u.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return u.clear=()=>{s.clearTimeout.call(void 0,i),i=void 0},u}var Rd=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Bd(r,e,t){let n,o=new Promise((s,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:u,removeListener:l}=Rd(r),f=async(...d)=>{let h=t.multiArgs?d:d[0];if(t.filter)try{if(!await t.filter(h))return}catch(v){n(),i(v);return}c.push(h),t.count===c.length&&(n(),s(c))},m=(...d)=>{n(),i(t.rejectionMultiArgs?d:d[0])};n=()=>{for(let d of a)l(d,f);for(let d of t.rejectionEvents)a.includes(d)||l(d,m)};for(let d of a)u(d,f);for(let d of t.rejectionEvents)a.includes(d)||u(d,m);t.signal&&t.signal.addEventListener("abort",()=>{m(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(o.cancel=n,typeof t.timeout=="number"){let s=$i(o,{milliseconds:t.timeout});return s.cancel=()=>{n(),s.clear()},s}return o}function Ye(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=Bd(r,e,t),o=n.then(s=>s[0]);return o.cancel=n.cancel,o}function Wi(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var to=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},Ft=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"};var ro=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function Od(r){return r.reason}async function St(r,e,t){if(e==null)return r;let n=t?.translateError??Od;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let o;try{return await Promise.race([r,new Promise((s,i)=>{o=()=>{i(n(e))},e.addEventListener("abort",o)})])}finally{o!=null&&e.removeEventListener("abort",o)}}var no=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Ve(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Xe)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Pd(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var oo=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Pd(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Xe),this.cleanup())}async join(e={}){let t=new no(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await St(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var so=class extends _e{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Wi(this.emitEmpty.bind(this),1),this.emitIdle=Wi(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new to;let n=new oo(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Xe)}),this.clear()}async onEmpty(e){this.size!==0&&await Ye(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await Ye(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ye(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=Et({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail)},s=c=>{n(c.detail.error)},i=()=>{n()},a=()=>{n(new Xe("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("failure",s),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",o),this.removeEventListener("failure",s),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",a),n()}}};var Nd=Math.pow(2,20)*4,io=class extends _e{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??Nd,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new J,this.writeBuffer=new J,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);let t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);let n=o=>{this.onDrainPromise?.reject(o.error??new ro)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),St(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;let e=Et(),t=s=>{e.push(s.data)};this.addEventListener("message",t);let n=s=>{e.end(s.error)};this.addEventListener("close",n);let o=()=>{e.end()};this.addEventListener("remoteCloseWrite",o);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",o)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new lt(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new yn(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new lt("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new lt("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new lt(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new lt(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");let e=new ln;this.dispatchEvent(new gn(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Yt))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0,t=this.writeBuffer.byteLength,n=0;for(;this.writeBuffer.byteLength>0;){let o=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(o===0){e=!1;break}let s=this.writeBuffer.sublist(0,o),i=new J(s);this.writeBuffer.consume(s.byteLength);let a=this.sendData(s);if(e=a.canSendMore,n+=a.sentBytes,a.sentBytes!==i.byteLength&&(i.consume(a.sentBytes),this.writeBuffer.prepend(i)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}let e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new mn(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new Ir(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new Ir(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};var ao=class extends io{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Ye(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Ye(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};function co(r){let e=new globalThis.AbortController;function t(){let s=r.filter(i=>i?.aborted===!0).map(i=>i?.reason).pop();e.abort(s);for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let s of r){if(s?.aborted===!0){t();break}s?.addEventListener!=null&&s.addEventListener("abort",t)}function n(){for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}let o=e.signal;return o.clear=n,o}var Gi=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Ve(),this.haveNext=Ve()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Ve(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Ve(),await St(this.readNext.promise,t?.signal,t)}};function qu(){return new Gi}function Ud(r){return r[Symbol.asyncIterator]!=null}async function Md(r,e,t){try{await Promise.all(r.map(async n=>{for await(let o of n)await e.push(o,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*kd(r){let e=new AbortController,t=qu();Md(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*Kd(r){for(let e of r)yield*e}function qd(...r){let e=[];for(let t of r)Ud(t)||e.push(t);return e.length===r.length?Kd(e):kd(r)}var Vu=qd;function Hu(r,...e){if(r==null)throw new Error("Empty pipeline");if(Zi(r)){let n=r;r=()=>n.source}else if(zu(r)||Fu(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&Zi(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Zi(t[n])&&(t[n]=Hd(t[n]));return Vd(...t)}var Vd=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},Fu=r=>r?.[Symbol.asyncIterator]!=null,zu=r=>r?.[Symbol.iterator]!=null,Zi=r=>r==null?!1:r.sink!=null&&r.source!=null,Hd=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=Et({objectMode:!0});t.then(()=>{n.end()},i=>{n.end(i)});let o,s=r.source;if(Fu(s))o=async function*(){yield*s,n.end()};else if(zu(s))o=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Vu(n,o())}return r.source};var Fd=4194304,uo=class extends Error{static name="UnwrappedError";name="UnwrappedError"},Xi=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ji=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Qi=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function zd(r){return typeof r?.closeRead=="function"}function $d(r){return typeof r?.close=="function"}function Yi(r){return zd(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:$d(r)?r.status!=="open":!1}function Wd(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function Gd(r,e){let t=e?.maxBufferSize??Fd,n=new J,o,s=!1;if(!Wd(r))throw new ie("Argument should be a Stream or a Multiaddr");let i=l=>{if(n.append(l.data),n.byteLength>t){let f=n.byteLength;n.consume(n.byteLength),o?.reject(new Error(`Read buffer overflow - ${f} > ${t}`))}o?.resolve()};r.addEventListener("message",i);let a=l=>{l.error!=null?o?.reject(l.error):o?.resolve()};r.addEventListener("close",a);let c=()=>{o?.resolve()};r.addEventListener("remoteCloseWrite",c);let u={readBuffer:n,async read(l){if(s===!0)throw new uo("Stream was unwrapped");if(Yi(r)){if(l?.bytes==null)return null;if(n.byteLength<l.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,l.bytes),new Ft(`Unexpected EOF - stream closed after reading ${n.byteLength}/${l.bytes} bytes`)}let f=l?.bytes??1;for(o=Promise.withResolvers();;){if(n.byteLength>=f){o.resolve();break}if(await St(o.promise,l?.signal),Yi(r)){if(n.byteLength===0&&l?.bytes==null)return null;break}o=Promise.withResolvers()}let m=l?.bytes??n.byteLength;if(n.byteLength<m){if(Yi(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,m),new Ft(`Unexpected EOF - stream closed while reading ${n.byteLength}/${m} bytes`);return u.read(l)}let d=n.sublist(0,m);return n.consume(m),d},async write(l,f){if(s===!0)throw new uo("Stream was unwrapped");r.send(l)||await Ye(r,"drain",{signal:f?.signal,rejectionEvents:["close"]})},unwrap(){return s||(s=!0,r.removeEventListener("message",i),r.removeEventListener("close",a),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return u}function Zd(r,e={}){let t=Gd(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=De(e.maxDataLength));let n=e?.lengthDecoder??zr,o=e?.lengthEncoder??fr;return{async read(i){let a=-1,c=new J;for(;;){let l=await t.read({...i,bytes:1});if(l==null)break;c.append(l);try{a=n(c)}catch(f){if(f instanceof RangeError)continue;throw f}if(a<0)throw new Xi("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new Qi(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new ji(`Message length too long - ${a} > ${e.maxDataLength}`);let u=await t.read({...i,bytes:a});if(u==null)throw r.log.error("tried to read %d bytes but the stream closed",a),new Ft(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(u.byteLength!==a)throw r.log.error("read %d/%d bytes before the stream closed",u.byteLength,a),new Ft(`Unexpected EOF - read ${u.byteLength}/${a} bytes before the stream closed`);return u},async write(i,a){await t.write(new J(o(i.byteLength),i),a)},async writeV(i,a){let c=new J(...i.flatMap(u=>[o(u.byteLength),u]));await t.write(c,a)},unwrap(){return t.unwrap()}}}function vt(r,e){let t=Zd(r,e),n={read:async(o,s)=>{let i=await t.read(s);return o.decode(i)},write:async(o,s,i)=>{await t.write(s.encode(o),i)},writeV:async(o,s,i)=>{await t.writeV(o.map(a=>s.encode(a)),i)},pb:o=>({read:async s=>n.read(o,s),write:async(s,i)=>n.write(s,o,i),writeV:async(s,i)=>n.writeV(s,o,i),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}function Yd(r){return r?.addEventListener!=null}function Xd(r){let e=Et(),t,n=i=>{e.push(i.data)},o=()=>{e.end(),r.removeEventListener("message",n),r.removeEventListener("close",s),r.removeEventListener("remoteCloseWrite",o)},s=i=>{e.end(i.error),i.error!=null&&t?.reject(i.error),r.removeEventListener("message",n),r.removeEventListener("close",s),r.removeEventListener("remoteCloseWrite",o)};return r.addEventListener("message",n),r.addEventListener("close",s,{once:!0}),r.addEventListener("remoteCloseWrite",o,{once:!0}),{source:e,async sink(i){async function*a(){yield*i}let c=a();for(;;){t=Promise.withResolvers();let{done:u,value:l}=await Promise.race([c.next(),t.promise]);if(r.writeStatus==="closing"||r.writeStatus==="closed"||(l!=null&&(r.send(l)||await Promise.race([Ye(r,"drain",{rejectionEvents:["close"]})])),u===!0))break}await r.close()}}}function $u(...r){let e=r.map(t=>Yd(t)?Xd(t):t);return Hu(...e)}var vr=class extends so{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var X=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),B=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),Wu=r=>({match:e=>r.match(e)===!1?e:!1}),F=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),Ee=(...r)=>({match:e=>{let t;for(let n of r){let o=n.match(e);o!==!1&&(t==null||o.length<t.length)&&(t=o)}return t??!1}}),G=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function j(...r){function e(o){if(o==null)return!1;let s=o.getComponents();for(let i of r){let a=i.match(s);if(a===!1)return!1;s=a}return s}function t(o){return e(o)!==!1}function n(o){let s=e(o);return s===!1?!1:s.length===0}return{matchers:r,matches:t,exactMatch:n}}var jd=B(421),rE=j(jd),fo=B(54),ho=B(55),po=B(56),ea=B(53),nE=j(fo,F(B(421))),oE=j(ho,F(B(421))),sE=j(po,F(B(421))),iE=j(Ee(ea,po,fo,ho),F(B(421))),Gu=G(B(4),F(B(43))),Zu=G(F(B(42)),B(41),F(B(43))),ta=Ee(Gu,Zu),zt=Ee(ta,ea,fo,ho,po),aE=j(Ee(ta,G(Ee(ea,po,fo,ho),F(B(421))))),cE=j(Gu),uE=j(Zu),lE=j(ta),ra=G(zt,B(6)),nn=G(zt,B(273)),fE=j(G(ra,F(B(421)))),hE=j(nn),na=G(nn,X(460),F(B(421))),mo=G(nn,X(461),F(B(421))),Qd=Ee(na,mo),dE=j(na),pE=j(mo),Ji=Ee(zt,ra,nn,na,mo),Yu=Ee(G(Ji,X(477),F(B(421)))),mE=j(Yu),Xu=Ee(G(Ji,X(478),F(B(421))),G(Ji,X(448),F(B(449)),X(477),F(B(421)))),yE=j(Xu),ju=G(nn,X(280),F(B(466)),F(B(466)),F(B(421))),gE=j(ju),Qu=G(mo,X(465),F(B(466)),F(B(466)),F(B(421))),bE=j(Qu),lo=Ee(Yu,Xu,G(ra,F(B(421))),G(Qd,F(B(421))),G(zt,F(B(421))),ju,Qu,B(421)),Ju=j(lo),Jd=G(F(lo),X(290),Wu(X(281)),F(B(421))),$t=j(Jd),ep=Ee(G(lo,X(290),X(281),F(B(421))),G(lo,X(281),F(B(421))),G(X(281),F(B(421)))),xE=j(ep),tp=Ee(G(zt,B(6),X(480),F(B(421))),G(zt,X(480),F(B(421)))),wE=j(tp),rp=G(zt,Ee(G(B(6,"443"),X(480)),G(B(6),X(443)),G(B(6),X(448),X(480)),G(X(448),X(480)),X(448),X(443)),F(B(421))),EE=j(rp),np=Ee(G(B(777),F(B(421)))),SE=j(np),op=Ee(G(B(400),F(B(421)))),vE=j(op);var oa=1e3,el=60*oa,tl=15,rl=120*el,nl=1,yo=5e3,ol=100,sa="circuit-relay-source",on=`${ba}-circuit-relay`,sl=2*el,il=BigInt(1<<17),Ue="/libp2p/circuit/relay/0.2.0/hop",Wt="/libp2p/circuit/relay/0.2.0/stop",al=30*oa,TE=30*oa,sn=300,cl=4096,ul=.001;var Y;(function(r){let e;(function(o){o.RESERVE="RESERVE",o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.RESERVE=0]="RESERVE",o[o.CONNECT=1]="CONNECT",o[o.STATUS=2]="STATUS"})(t||(t={})),(function(o){o.codec=()=>Ut(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Re((o,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),o.type!=null&&(s.uint32(8),r.Type.codec().encode(o.type,s)),o.peer!=null&&(s.uint32(18),_r.codec().encode(o.peer,s)),o.reservation!=null&&(s.uint32(26),go.codec().encode(o.reservation,s)),o.limit!=null&&(s.uint32(34),Ar.codec().encode(o.limit,s)),o.status!=null&&(s.uint32(40),H.codec().encode(o.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(o,s,i={})=>{let a={},c=s==null?o.len:o.pos+s;for(;o.pos<c;){let u=o.uint32();switch(u>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=_r.codec().decode(o,o.uint32(),{limits:i.limits?.peer});break}case 3:{a.reservation=go.codec().decode(o,o.uint32(),{limits:i.limits?.reservation});break}case 4:{a.limit=Ar.codec().decode(o,o.uint32(),{limits:i.limits?.limit});break}case 5:{a.status=H.codec().decode(o);break}default:{o.skipType(u&7);break}}}return a})),n),r.encode=o=>Le(o,r.codec()),r.decode=(o,s)=>Ce(o,r.codec(),s)})(Y||(Y={}));var Pe;(function(r){let e;(function(o){o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.CONNECT=0]="CONNECT",o[o.STATUS=1]="STATUS"})(t||(t={})),(function(o){o.codec=()=>Ut(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Re((o,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),o.type!=null&&(s.uint32(8),r.Type.codec().encode(o.type,s)),o.peer!=null&&(s.uint32(18),_r.codec().encode(o.peer,s)),o.limit!=null&&(s.uint32(26),Ar.codec().encode(o.limit,s)),o.status!=null&&(s.uint32(32),H.codec().encode(o.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(o,s,i={})=>{let a={},c=s==null?o.len:o.pos+s;for(;o.pos<c;){let u=o.uint32();switch(u>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=_r.codec().decode(o,o.uint32(),{limits:i.limits?.peer});break}case 3:{a.limit=Ar.codec().decode(o,o.uint32(),{limits:i.limits?.limit});break}case 4:{a.status=H.codec().decode(o);break}default:{o.skipType(u&7);break}}}return a})),n),r.encode=o=>Le(o,r.codec()),r.decode=(o,s)=>Ce(o,r.codec(),s)})(Pe||(Pe={}));var _r;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let s of t.addrs)n.uint32(18),n.bytes(s);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={id:re(0),addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.id=t.bytes();break}case 2:{if(o.limits?.addrs!=null&&s.addrs.length===o.limits.addrs)throw new Gr('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(_r||(_r={}));var go;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),bo.codec().encode(t.voucher,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={expire:0n,addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(o.limits?.addrs!=null&&s.addrs.length===o.limits.addrs)throw new Gr('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=bo.codec().decode(t,t.uint32(),{limits:o.limits?.voucher});break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(go||(go={}));var Ar;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(Ar||(Ar={}));var H;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(H||(H={}));var ia;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(ia||(ia={}));(function(r){r.codec=()=>Ut(ia)})(H||(H={}));var Tr;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={relay:re(0),peer:re(0),expiration:0n},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(Tr||(Tr={}));var bo;(function(r){let e;r.codec=()=>(e==null&&(e=Re((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),Tr.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let s={publicKey:re(0),payloadType:re(0),signature:re(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=Tr.codec().decode(t,t.uint32(),{limits:o.limits?.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Le(t,r.codec()),r.decode=(t,n)=>Ce(t,r.codec(),n)})(bo||(bo={}));var xo=class extends Error{constructor(e="Transfer limit error"){super(e),this.name="TransferLimitError"}},wo=class extends Error{constructor(e="Duration limit error"){super(e),this.name="DurationLimitError"}},an=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},Eo=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},So=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function ll(r,e,t){let n=e.remaining,o=s=>{let i=BigInt(s.data.byteLength);e.remaining-=i,e.remaining<0&&r.abort(new xo(`data limit of ${n} bytes exceeded`))};r.addEventListener("message",o)}function fl(r,e,t,n,o){function s(l){r.abort(l),e.abort(l)}let i=[t,n.signal];if(n.limit?.duration!=null){o.log("limiting relayed connection duration to %dms",n.limit.duration);let l=AbortSignal.timeout(n.limit.duration);i.push(l)}let a=co(i);let c;n.limit?.data!=null&&(c={remaining:n.limit.data});let u=()=>{let l;t.aborted?l=t.reason:l=new wo(`duration limit of ${n.limit?.duration} ms exceeded`),s(l)};a.addEventListener("abort",u,{once:!0}),c!=null&&(ll(e,c,o),ll(r,c,o)),$u(r,e,r).catch(l=>{s(l)}).finally(()=>{a.clear()})}function aa(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var cn=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},vo=j(G(Ju.matchers[0],X(290))),_o=j(X(290));function Ao(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:e(o)}}};return t}var _t=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ao(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Ao(this.map.values(),e=>e.key)}values(){return Ao(this.map.values(),e=>e.value)}get size(){return this.map.size}};var To=class{filter;constructor(e,t){this.filter=Er(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function ca(r,e=.001){return new To(r,e)}var ua=class extends _t{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function la(r){let{name:e,metrics:t}=r,n;return t!=null?n=new ua({name:e,metrics:t}):n=new _t,n}var fa=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};function hl(r,e){let t=new fa(e?.errorMessage,e?.errorCode,e?.errorName),n=new AbortController,o=()=>{n.abort(t)},s=AbortSignal.timeout(r);s.addEventListener("abort",o);let i=n.signal;return i.reset=a=>{s?.removeEventListener("abort",o),s=AbortSignal.timeout(a??r),s.addEventListener("abort",()=>{n.abort(t)})},i.clear=()=>{s?.removeEventListener("abort",o),s=void 0},i}var Io=class{reservations;maxReservations;applyDefaultLimit;reservationTtl;defaultDurationLimit;defaultDataLimit;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:server:reservation-store"),this.maxReservations=t.maxReservations??tl,this.applyDefaultLimit=t.applyDefaultLimit!==!1,this.reservationTtl=t.reservationTtl??rl,this.defaultDurationLimit=t.defaultDurationLimit??sl,this.defaultDataLimit=t.defaultDataLimit??il,this.reservations=la({metrics:e.metrics,name:"libp2p_circuit_relay_server_reservations_total"})}reserve(e,t,n){let o=this.reservations.get(e);if(this.reservations.size>=this.maxReservations&&o==null)return{status:H.RESERVATION_REFUSED};let s=new Date(Date.now()+this.reservationTtl),i;return this.applyDefaultLimit&&(i=n??{data:this.defaultDataLimit,duration:this.defaultDurationLimit}),o!=null?(this.log("refreshing reservation for client %p",e),o.signal.reset(this.reservationTtl)):(this.log("creating new reservation for client %p",e),o={addr:t,expiry:s,limit:i,signal:hl(this.reservationTtl)}),this.reservations.set(e,o),o.signal.addEventListener("abort",()=>{this.reservations.delete(e)}),{status:H.OK,expire:Math.round(s.getTime()/1e3)}}removeReservation(e){this.reservations.delete(e)}get(e){return this.reservations.get(e)}clear(){this.reservations.clear()}};var Do=class r{domain="libp2p-relay-rsvp";codec=new Uint8Array([3,2]);relay;peer;expiration;constructor({relay:e,peer:t,expiration:n}){this.relay=e,this.peer=t,this.expiration=n}marshal(){return Tr.encode({relay:this.relay.toMultihash().bytes,peer:this.peer.toMultihash().bytes,expiration:BigInt(this.expiration)})}equals(e){return!(!(e instanceof r)||!this.peer.equals(e.peer)||!this.relay.equals(e.relay)||this.expiration!==e.expiration)}};var sp={maxOutboundStopStreams:sn},Co=class extends _e{components;reservationStore;started;hopTimeout;shutdownController;maxInboundHopStreams;maxOutboundHopStreams;maxOutboundStopStreams;log;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:server"),this.components=e,this.started=!1,this.hopTimeout=t?.hopTimeout??al,this.maxInboundHopStreams=t.maxInboundHopStreams,this.maxOutboundHopStreams=t.maxOutboundHopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??sp.maxOutboundStopStreams,this.reservationStore=new Io(e,t.reservations),this.shutdownController=new AbortController,this.shutdownController.signal,this.onHop=this.onHop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-server";isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(Ue,this.onHop,{maxInboundStreams:this.maxInboundHopStreams,maxOutboundStreams:this.maxOutboundHopStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){this.reservationStore.clear(),this.shutdownController.abort(),await this.components.registrar.unhandle(Ue),this.started=!1}async onHop(e,t){this.log("received circuit v2 hop protocol stream from %p",t.remotePeer);let n=AbortSignal.timeout(this.hopTimeout);let o={signal:n},s=vt(e);try{let i=await s.pb(Y).read(o);if(i?.type==null)throw new Error("request was invalid, could not read from stream");this.log("received",i.type),await this.handleHopProtocol({connection:t,stream:s,request:i},o)}catch(i){this.log.error("error while handling hop - %e",i),await s.pb(Y).write({type:Y.Type.STATUS,status:H.MALFORMED_MESSAGE},o),e.abort(i)}}async handleHopProtocol({stream:e,request:t,connection:n},o){switch(this.log("received hop message"),t.type){case Y.Type.RESERVE:await this.handleReserve({stream:e,request:t,connection:n},o);break;case Y.Type.CONNECT:await this.handleConnect({stream:e,request:t,connection:n},o);break;default:this.log.error("invalid hop request type %s via peer %p",t.type,n.remotePeer),await e.pb(Y).write({type:Y.Type.STATUS,status:H.UNEXPECTED_MESSAGE})}}async handleReserve({stream:e,connection:t},n){let o=e.pb(Y);if(this.log("hop reserve request from %p",t.remotePeer),$t.exactMatch(t.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",t.remotePeer),await o.write({type:Y.Type.STATUS,status:H.PERMISSION_DENIED},n);return}if(await this.components.connectionGater.denyInboundRelayReservation?.(t.remotePeer)===!0){this.log.error("reservation for %p denied by connection gater",t.remotePeer),await o.write({type:Y.Type.STATUS,status:H.PERMISSION_DENIED},n);return}let s=this.reservationStore.reserve(t.remotePeer,t.remoteAddr);try{if(s.status!==H.OK){await o.write({type:Y.Type.STATUS,status:s.status},n);return}if(s.expire!=null){let i=s.expire*1e3-Date.now();await this.components.peerStore.merge(t.remotePeer,{tags:{[sa]:{value:1,ttl:i}}},n)}await o.write({type:Y.Type.STATUS,status:H.OK,reservation:await this.makeReservation(t.remotePeer,BigInt(s.expire??0)),limit:this.reservationStore.get(t.remotePeer)?.limit},n),this.log("sent confirmation response to %s",t.remotePeer),await o.unwrap().unwrap().close(n)}catch(i){this.log.error("failed to send confirmation response to %p - %e",t.remotePeer,i),this.reservationStore.removeReservation(t.remotePeer);try{await this.components.peerStore.merge(t.remotePeer,{tags:{[sa]:void 0}},n)}catch(a){this.log.error("failed to untag relay source peer %p - %e",t.remotePeer,a)}}}async makeReservation(e,t){let n=[];for(let s of this.components.addressManager.getAddresses())s.toString().includes("/p2p-circuit")||n.push(s.bytes);let o=await Jr.seal(new Do({peer:e,relay:this.components.peerId,expiration:t}),this.components.privateKey);return{addrs:n,expire:t,voucher:{publicKey:$e(o.publicKey),payloadType:o.payloadType,payload:{peer:e.toMultihash().bytes,relay:this.components.peerId.toMultihash().bytes,expiration:t},signature:o.signature}}}async handleConnect({stream:e,request:t,connection:n},o){let s=e.pb(Y);if($t.matches(n.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",n.remotePeer),await s.write({type:Y.Type.STATUS,status:H.PERMISSION_DENIED},o);return}this.log("hop connect request from %p",n.remotePeer);let i;try{if(t.peer==null)throw this.log.error("no peer info in hop connect request"),new Error("no peer info in request");t.peer.addrs.forEach(Oe),i=yr(ze(t.peer.id))}catch(f){this.log.error("invalid hop connect request via peer %p - %e",n.remotePeer,f),await s.write({type:Y.Type.STATUS,status:H.MALFORMED_MESSAGE},o);return}let a=this.reservationStore.get(i);if(a==null){this.log.error("hop connect denied for destination peer %p not having a reservation for %p with status %s",i,n.remotePeer,H.NO_RESERVATION),await s.write({type:Y.Type.STATUS,status:H.NO_RESERVATION},o);return}if(await this.components.connectionGater.denyOutboundRelayedConnection?.(n.remotePeer,i)===!0){this.log.error("hop connect for %p to %p denied by connection gater",n.remotePeer,i),await s.write({type:Y.Type.STATUS,status:H.PERMISSION_DENIED},o);return}let c=this.components.connectionManager.getConnections(i);if(c.length===0){this.log("hop connect denied for destination peer %p not having a connection for %p as there is no destination connection",i,n.remotePeer),await s.write({type:Y.Type.STATUS,status:H.NO_RESERVATION},o);return}let u=c[0],l=await this.stopHop({connection:u,request:{type:Pe.Type.CONNECT,peer:{id:n.remotePeer.toMultihash().bytes,addrs:[]},limit:a?.limit}},o);if(l==null){this.log.error("failed to open stream to destination peer %p",u?.remotePeer),await s.write({type:Y.Type.STATUS,status:H.CONNECTION_FAILED},o);return}await s.write({type:Y.Type.STATUS,status:H.OK,limit:a?.limit},o),this.log("connection from %p to %p established - merging streams",n.remotePeer,i),fl(e.unwrap(),l,this.shutdownController.signal,a,{log:this.log})}async stopHop({connection:e,request:t},n){this.log("starting circuit relay v2 stop request to %s",e.remotePeer);let o=await e.newStream(Wt,{maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0,...n}),s=vt(o),i=s.pb(Pe);await i.write(t,n);let a;try{a=await i.read(n)}catch(c){this.log.error("error parsing stop message response from %p - %e",e.remotePeer,c)}if(a==null){this.log.error("could not read response from %p",e.remotePeer),await o.close(n);return}if(a.status===H.OK)return this.log("stop request to %p was successful",e.remotePeer),s.unwrap();this.log("stop request failed with code %d",a.status),await o.close(n)}get reservations(){return this.reservationStore.reservations}};var At=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var Lo=class extends _e{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Ue,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(Ue)],orders:[()=>Math.random()<.5?1:-1,(n,o)=>{let s=dl(n),i=dl(o);return s>i?-1:i>s?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new vr({concurrency:5});this.log("start random walk");for await(let n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(o=>o.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p - %e",n.id,o)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;let t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,o)})}async dialPeer({peerId:e,signal:t}){let n=co([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}};function dl(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date($(e)).getTime()}var da=class extends _e{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??yo,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(_o.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(vo.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),o=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(o.remotePeer)){this.log("making reservation on peer %p",o.remotePeer);let s=await this.reservationStore.addRelay(o.remotePeer,"configured");this.addedRelay(s)}}else throw new Tt(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>Oe(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function pl(r){return new da(r)}var ml="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var yl=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=ml[t[r]&63];return e};var ip=60*1e3*10,ap=60*1e3*5,cp=30*1e3,Ro=class extends _e{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new _t,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??ol,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??yo,this.started=!1,this.relayFilter=Er(100),this.reserveQueue=new vr({concurrency:t?.reservationConcurrency??nl,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(s=>s.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(s=>{this.log("could not remove relay %p - %e",n.detail,s)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(on)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[on]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=yl();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Tt("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new So("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Tt("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let o=Date.now();try{let s=this.reservations.get(e);if(s!=null){let h=this.connectionManager.getConnections(e),v=!1;if(h.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),h.map(x=>x.id).includes(s.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),v=!0),v&&aa(s.reservation.expire)>ip)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:s};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new an("Not making reservation on discovered relay because we do not need any more relays");let i=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:i});if($t.matches(a.remoteAddr))throw new Eo("not creating reservation over relayed connection");let c=await this.#e(a,{signal:i}),u=aa(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+u).toString());let l=Math.min(Math.max(u-ap,cp),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async h=>{this.log.error("could not refresh reservation to relay %p - %e",e,h),await this.#t(e)}).catch(h=>{this.log.error("could not remove expired reservation to relay %p - %e",e,h)})},l),m;if(t==="discovered"){let h=this.pendingReservations.pop();if(h==null)throw new an("Made reservation on relay but did not need any more discovered relays");m={timeout:f,reservation:c,type:t,connection:a.id,id:h}}else m={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,m),await this.peerStore.merge(e,{tags:{[on]:{value:1,ttl:u}}}),this.#r();let d={relay:e,details:m};return this.safeDispatchEvent("relay:created-reservation",{detail:d}),d}catch(s){throw t==="discovered"&&s.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-o,s),(s.name==="DialError"||s.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(i=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,i)}),s}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(Ue,t),s=vt(n).pb(Y);this.log.trace("send RESERVE to %p",e.remotePeer),await s.write({type:Y.Type.RESERVE},t);let i;try{this.log.trace("reading response from %p",e.remotePeer),i=await s.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",i.status),i.status===H.OK&&i.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let u of i.reservation.addrs){let l=Oe(u);l.getComponents().find(f=>f.code===421)==null&&(l=l.encapsulate(`/p2p/${e.remotePeer}`)),l=Oe(l.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(l.toString())}return i.reservation.addrs=[...c].map(u=>Oe(u).bytes),i.reservation}let a=`reservation failed with status ${i.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[on]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Er(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var pa=class extends ao{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}};function ma(r){return new pa(r)}var up=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(Oe)}catch{return!1}return!0},gl={maxInboundStopStreams:sn,maxOutboundStopStreams:sn,stopTimeout:3e4},Bo=class{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??gl.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??gl.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new Lo(e,{filter:t.discoveryFilter??ca(cl,ul)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(o=>{o.name!=="HadEnoughRelaysError"&&o.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,o)})}),this.reservationStore=new Ro(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[_a]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Aa](){return this.discovery!=null?["@libp2p/identify"]:[]}[va]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(Wt,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await wa(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Ea(this.discovery,this.reservationStore),await this.components.registrar.unhandle(Wt),this.started=!1}async dial(e,t){let n=e.toString().split("/p2p-circuit"),o=Oe(n[0]),s=Oe(n[n.length-1]),i=o.getComponents().find(d=>d.code===421)?.value,a=s.getComponents().find(d=>d.code===421)?.value;if(i==null||a==null){let d=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${d}`),new pn(`C${d}`)}let c=mi(i),u=mi(a),f=this.components.connectionManager.getConnections(c)[0];f==null?(await this.components.peerStore.merge(c,{multiaddrs:[o]}),t.onProgress?.(new At("circuit-relay:open-connection")),f=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new At("circuit-relay:reuse-connection"));let m;try{t.onProgress?.(new At("circuit-relay:open-hop-stream")),m=await f.newStream(Ue,t);let d=vt(m).pb(Y);t.onProgress?.(new At("circuit-relay:write-connect-message")),await d.write({type:Y.Type.CONNECT,peer:{id:u.toMultihash().bytes,addrs:[Oe(s).bytes]}},t),t.onProgress?.(new At("circuit-relay:read-connect-response"));let h=await d.read(t);if(h.status!==H.OK)throw new dn(`failed to connect via relay with status ${h?.status?.toString()??"undefined"}`);let v=new cn(h.limit),x=ma({stream:d.unwrap().unwrap(),remoteAddr:e,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:v.onData,onDataWrite:v.onData,log:m.log.newScope("circuit-relay:connection")}),y=await this.components.upgrader.upgradeOutbound(x,{...t,limits:v.getLimits()});return y.log("outbound relayed connection established to %p with limits %o, over connection %s",y.remotePeer,h.limit??"none",f.id),y}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",u,c,d),m?.abort(d),d}}createListener(e){return pl({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>vo.exactMatch(t)||_o.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>$t.exactMatch(t))}async onStop(e,t){let n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",f)}let o=vt(e).pb(Pe),s=await o.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,s.type),s?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await o.write({type:Pe.Type.STATUS,status:H.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(s.type!==Pe.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await o.write({type:Pe.Type.STATUS,status:H.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!up(s)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await o.write({type:Pe.Type.STATUS,status:H.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}let i=yr(ze(s.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,i)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await o.write({type:Pe.Type.STATUS,status:H.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await o.write({type:Pe.Type.STATUS,status:H.OK},{signal:n});let a=new cn(s.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${i.toString()}`),u=this.components.addressManager.getAddresses()[0],l=ma({stream:o.unwrap().unwrap(),remoteAddr:c,localAddr:u,onDataRead:a.onData,onDataWrite:a.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),l.log("inbound relayed connection established to %p with limits %o, over connection %s",i,s.limit??"none",t.id)}finally{n?.clear()}}};function lp(r={}){return e=>new Co(e,r)}function fp(r={}){return e=>new Bo(e,r)}return Sl(hp);})();
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
return Libp2PCircuitRelayV2}));
//# sourceMappingURL=index.min.js.map
