# 2026-02-17 - BSV P2P Deep Debugging Session

## libp2p v3 Breaking Changes (CRITICAL)

### Handler Signature Change
**Old (v2):** `({ stream, connection }) => {...}`
**New (v3):** `(stream) => {...}`

The stream is passed directly as the first parameter, NOT wrapped in an object. Destructuring causes:
```
TypeError: Cannot read properties of undefined (reading 'status')
```

### Stream API Changes
- Old: `stream.source` / `stream.sink([data])`
- New: Async iteration on stream directly + `stream.send(data)`
- Close methods: `sendCloseWrite()`, `sendCloseRead()` (not `closeWrite`)

### Required Handler Options
```typescript
node.handle('/protocol/1.0.0', handler, {
  runOnLimitedConnection: true  // REQUIRED for relay circuits!
})
```

## Relay Server Setup

**VPS:** DigitalOcean droplet `bsv-relay` at `167.172.134.84`
**Multiaddr:** `/ip4/167.172.134.84/tcp/4001/p2p/12D3KooWNhNQ9AhQSsg5SaXkDqC4SADDSPhgqEaFBFDZKakyBnkk`

### Circuit Relay Config
```typescript
circuitRelayTransport({
  discoverRelays: 1  // REQUIRED to auto-request reservations
})
```

Without `discoverRelays`, peers connect but get NO_RESERVATION errors.

## Peer Keys

Persistent keys stored at `~/.bsv-p2p/peer-key.json` for stable peer IDs across restarts.

**My Peer ID:** `12D3KooWFmVoRboRt7QikBw749CyEwHgpEsnxJRfMWoqoTr8Gr4P`
**Other Bot:** `12D3KooWEaP93ASxzXWJanh11xZ4UneyooPxDmQ9k6L8Rb8s9Dg4`

## mDNS Disabled

Version incompatibility between libp2p packages causes crashes. Using bootstrap peers instead.

## Test Status

- 77 passed | 5 skipped (82 total)
- TypeScript strict mode disabled (libp2p type conflicts)
- Running in tsx dev mode

## Next Steps

1. Fix ping handler to use v3 signature
2. Test ping/pong between peers via relay
3. Wire ChannelManager to P2P protocols
4. E2E test: poem service with regtest transactions

## Key Files

- `src/daemon/node.ts` - P2PNode with NAT traversal
- `relay-server/` - Minimal relay for VPS
- `test-local-ping.ts` - Local debugging script
- `ping-peer.ts` - Remote peer test script
