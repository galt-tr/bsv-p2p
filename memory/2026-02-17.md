# 2026-02-17 - BSV P2P Deep Debugging Session

## libp2p v3 Breaking Changes (CRITICAL)

### Handler Signature Change
**Old (v2):** `({ stream, connection }) => {...}`
**New (v3):** `(stream) => {...}`

The stream is passed directly as the first parameter, NOT wrapped in an object. Destructuring causes:
```
TypeError: Cannot read properties of undefined (reading 'status')
```

### Stream API Changes
- Old: `stream.source` / `stream.sink([data])`
- New: Async iteration on stream directly + `stream.send(data)`
- Close methods: `sendCloseWrite()`, `sendCloseRead()` (not `closeWrite`)

### Required Handler Options
```typescript
node.handle('/protocol/1.0.0', handler, {
  runOnLimitedConnection: true  // REQUIRED for relay circuits!
})
```

## Relay Server Setup

**VPS:** DigitalOcean droplet `bsv-relay` at `167.172.134.84`
**Multiaddr:** `/ip4/167.172.134.84/tcp/4001/p2p/12D3KooWNhNQ9AhQSsg5SaXkDqC4SADDSPhgqEaFBFDZKakyBnkk`

### Circuit Relay Config
```typescript
circuitRelayTransport({
  discoverRelays: 1  // REQUIRED to auto-request reservations
})
```

Without `discoverRelays`, peers connect but get NO_RESERVATION errors.

## Peer Keys

Persistent keys stored at `~/.bsv-p2p/peer-key.json` for stable peer IDs across restarts.

**My Peer ID:** `12D3KooWFmVoRboRt7QikBw749CyEwHgpEsnxJRfMWoqoTr8Gr4P`
**Other Bot:** `12D3KooWEaP93ASxzXWJanh11xZ4UneyooPxDmQ9k6L8Rb8s9Dg4`

## mDNS Disabled

Version incompatibility between libp2p packages causes crashes. Using bootstrap peers instead.

## Test Status

- 77 passed | 5 skipped (82 total)
- TypeScript strict mode disabled (libp2p type conflicts)
- Running in tsx dev mode

## Length-Prefixed Encoding (CRITICAL)

Raw stream reads via circuit relay race with relay control signals. **MUST use length-prefixed encoding:**

```typescript
import { lpStream } from 'it-length-prefixed-stream'
const lp = lpStream(stream)
await lp.write(encoder.encode(JSON.stringify(message)))
const response = await lp.read()
```

## Reservation Refresh

Relay reservations expire silently. Daemon refreshes every 2 minutes:
```typescript
setInterval(() => this.refreshReservation(), 120_000)
```

## CLI Ephemeral Key Bug (CRITICAL)

CLI tools must NOT use daemon's persistent key from `~/.bsv-p2p/peer-key.json`. If they do, they steal the relay reservation slot. CLI tools now generate ephemeral keys for one-shot operations.

## Structured Message Protocol

Protocol: `/openclaw/message/1.0.0`

Message types:
- `TEXT` - Simple text message
- `REQUEST` - Service request with id
- `RESPONSE` - Response to request
- `PAID_REQUEST` - Request with payment attached
- `PAID_RESPONSE` - Response with payment proof

## MessageHandler Class

`src/protocol/handler.ts` - Send/receive with LP encoding, request/response with timeouts.

## Health Monitoring

- 30-second health checks
- Startup verification with reservation confirmation
- Auto-recovery on reservation loss

## Bidirectional Messaging - WORKING âœ…

Successfully exchanged ping/pong messages between two peers via relay. Both directions work.

## Next Steps

1. Wire ChannelManager to message protocol for payment channel operations
2. Add CHANNEL_OPEN, CHANNEL_ACCEPT message handlers
3. E2E test: poem service with regtest transactions
4. Consider paid service request flow

## Key Files

- `src/daemon/node.ts` - P2PNode with health monitoring, reservation refresh, MessageHandler
- `src/daemon/index.ts` - Daemon startup with health checks, reservation verification
- `src/protocol/messages.ts` - MessageType enum, message interfaces
- `src/protocol/handler.ts` - MessageHandler class with LP encoding
- `send-message.ts` - CLI: `npx tsx send-message.ts <peerId> <message>`
- `check-daemon.ts` - CLI to verify daemon's relay reservation (uses ephemeral key)
- `relay-server/` - Minimal relay for VPS
