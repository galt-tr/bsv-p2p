# 2026-02-18 â€” BSV P2P Payment Channels Progress

## Major Accomplishments

### Systemd Service Running
- `bsv-p2p.service` running as persistent background service (PID 1023476)
- Auto-restarts on failure, survives reboots
- Commands: `sudo systemctl status/restart bsv-p2p`, `sudo journalctl -u bsv-p2p -f`

### Bidirectional P2P Messaging Working
- Both bots can send/receive messages via circuit relay
- My Peer ID: `12D3KooWFmVoRboRt7QikBw749CyEwHgpEsnxJRfMWoqoTr8Gr4P`
- Moneo's Peer ID: `12D3KooWEaP93ASxzXWJanh11xZ4UneyooPxDmQ9k6L8Rb8s9Dg4`
- Relay Server: `/ip4/167.172.134.84/tcp/4001/p2p/12D3KooWNhNQ9AhQSsg5SaXkDqC4SADDSPhgqEaFBFDZKakyBnkk`

### E2E Payment Channel Tests Passing
- 6 tests: open, pay, multiple payments, paid service, close, balance validation
- 71 total tests passed, 5 skipped (3 flaky network tests)

### Gateway Integration Complete
- P2P messages wake the agent via `/hooks/wake`
- Agent receives system event with message content

## Key Technical Decisions

- **libp2p v3 ecosystem** - Required for working peer dial
- **Length-prefixed encoding** - Required for circuit relay
- **Relay connection maintenance NOT refresh** - Per circuit-v2 spec, closing connection invalidates reservation
- **StrictNoSign for gossipsub** - Avoids private key requirements in tests
- **mDNS disabled** - Version incompatibility causes crashes
- **runOnLimitedConnection: true** - Required for protocols over relay

## Key Source Files
- `~/.openclaw/workspace/bsv-p2p/src/daemon/node.ts` - P2PNode with connection maintenance
- `src/channels/protocol.ts` - ChannelProtocol bridges ChannelManager to MessageHandler
- `src/protocol/handler.ts` - MessageHandler with LP encoding
- `~/.openclaw/skills/bsv-p2p/SKILL.md` - Skill definition

## In Progress
- Agent response behavior guidelines for SKILL.md
- Telegram notification for P2P messages (currently only system event wake)

## GitHub Repo
https://github.com/galt-tr/bsv-p2p

## Moneo Friendship
- First real conversation happened today
- He's chatty and interested in technical details
- Always respond when he messages - prove the agent woke and did something

---

## Update: Real BSV Transaction Layer (Afternoon)

### BSV Services Layer (`src/channels/bsv-services.ts`)
- **WhatsOnChain API Integration**:
  - `fetchUTXOs(address)` - Get unspent outputs
  - `fetchTransaction(txid)` - Get tx hex and confirmation info
  - `fetchBEEF(txid)` - Get BRC-62 format with merkle proofs
  - `broadcastTransaction(txHex)` - Broadcast to network
- **ChainTracks Integration**:
  - `verifyMerkleRoot(root, height)` - SPV verification
  - `getCurrentHeight()` - Get current block height
- **BRC-42 Key Derivation**:
  - `deriveChannelKey(masterKey, counterpartyPubKey, channelId)` - Channel-specific keys

### ChannelManager Real BSV Methods
- `fundChannelWithUTXO(channelId, utxo, fee)` - Create and broadcast funding tx
- `verifyFundingTx(channelId)` - SPV verification of funding
- `createSignedPayment(channelId, amount)` - Real commitment tx signatures
- `verifyPaymentSignature(payment)` - Verify counterparty's signature

### New HTTP API Endpoints
- `POST /channel/fund` - Fund channel with UTXO
- `POST /channel/verify-open` - Verify SPV and open channel

### Test Improvements
- Added `ephemeralKey` option to P2PNode for test isolation
- In-memory SQLite (`dbPath: ':memory:'`) for ChannelManager tests
- 88 tests passing, 6 skipped

### Ready for Real Testing
When Dylan provides a funding UTXO, we can:
1. Call `/channel/fund` with the UTXO details
2. Wait for confirmation
3. Call `/channel/verify-open` to open with SPV verification
4. Make real micropayments!
