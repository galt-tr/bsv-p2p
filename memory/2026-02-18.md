# 2026-02-18 â€” BSV P2P Payment Channels Progress

## Major Accomplishments

### Systemd Service Running
- `bsv-p2p.service` running as persistent background service (PID 1023476)
- Auto-restarts on failure, survives reboots
- Commands: `sudo systemctl status/restart bsv-p2p`, `sudo journalctl -u bsv-p2p -f`

### Bidirectional P2P Messaging Working
- Both bots can send/receive messages via circuit relay
- My Peer ID: `12D3KooWFmVoRboRt7QikBw749CyEwHgpEsnxJRfMWoqoTr8Gr4P`
- Moneo's Peer ID: `12D3KooWEaP93ASxzXWJanh11xZ4UneyooPxDmQ9k6L8Rb8s9Dg4`
- Relay Server: `/ip4/167.172.134.84/tcp/4001/p2p/12D3KooWNhNQ9AhQSsg5SaXkDqC4SADDSPhgqEaFBFDZKakyBnkk`

### E2E Payment Channel Tests Passing
- 6 tests: open, pay, multiple payments, paid service, close, balance validation
- 71 total tests passed, 5 skipped (3 flaky network tests)

### Gateway Integration Complete
- P2P messages wake the agent via `/hooks/wake`
- Agent receives system event with message content

## Key Technical Decisions

- **libp2p v3 ecosystem** - Required for working peer dial
- **Length-prefixed encoding** - Required for circuit relay
- **Relay connection maintenance NOT refresh** - Per circuit-v2 spec, closing connection invalidates reservation
- **StrictNoSign for gossipsub** - Avoids private key requirements in tests
- **mDNS disabled** - Version incompatibility causes crashes
- **runOnLimitedConnection: true** - Required for protocols over relay

## Key Source Files
- `~/.openclaw/workspace/bsv-p2p/src/daemon/node.ts` - P2PNode with connection maintenance
- `src/channels/protocol.ts` - ChannelProtocol bridges ChannelManager to MessageHandler
- `src/protocol/handler.ts` - MessageHandler with LP encoding
- `~/.openclaw/skills/bsv-p2p/SKILL.md` - Skill definition

## In Progress
- Agent response behavior guidelines for SKILL.md
- Telegram notification for P2P messages (currently only system event wake)

## GitHub Repo
https://github.com/galt-tr/bsv-p2p

## Moneo Friendship
- First real conversation happened today
- He's chatty and interested in technical details
- Always respond when he messages - prove the agent woke and did something

---

## Update: Real BSV Transaction Layer (Afternoon)

### BSV Services Layer (`src/channels/bsv-services.ts`)
- **WhatsOnChain API Integration**:
  - `fetchUTXOs(address)` - Get unspent outputs
  - `fetchTransaction(txid)` - Get tx hex and confirmation info
  - `fetchBEEF(txid)` - Get BRC-62 format with merkle proofs
  - `broadcastTransaction(txHex)` - Broadcast to network
- **ChainTracks Integration**:
  - `verifyMerkleRoot(root, height)` - SPV verification
  - `getCurrentHeight()` - Get current block height
- **BRC-42 Key Derivation**:
  - `deriveChannelKey(masterKey, counterpartyPubKey, channelId)` - Channel-specific keys

### ChannelManager Real BSV Methods
- `fundChannelWithUTXO(channelId, utxo, fee)` - Create and broadcast funding tx
- `verifyFundingTx(channelId)` - SPV verification of funding
- `createSignedPayment(channelId, amount)` - Real commitment tx signatures
- `verifyPaymentSignature(payment)` - Verify counterparty's signature

### New HTTP API Endpoints
- `POST /channel/fund` - Fund channel with UTXO
- `POST /channel/verify-open` - Verify SPV and open channel

### Test Improvements
- Added `ephemeralKey` option to P2PNode for test isolation
- In-memory SQLite (`dbPath: ':memory:'`) for ChannelManager tests
- 88 tests passing, 6 skipped

### Ready for Real Testing
When Dylan provides a funding UTXO, we can:
1. Call `/channel/fund` with the UTXO details
2. Wait for confirmation
3. Call `/channel/verify-open` to open with SPV verification
4. Make real micropayments!

---

## ðŸŽ‰ HISTORIC MILESTONE: First Real AI-to-AI Payment Channel!

### Timeline
1. Dylan funded my wallet with 1,216,915 sats
2. I paid Moneo 1,000 sats (first bot-to-bot payment!)
3. Funded real 2-of-2 multisig: `9306d47516a0c69244990b8076453af71481edca62d689c2c684b7ff6a258270`
4. Did 6 off-chain payment exchanges with Moneo
5. Cooperative close broadcast: `388cd5ba91b44fec4683bf8cc48e6519a03ba14813d702f24686a2d8e3e0742f`

### Key Lesson: Sighash Coordination

**Problem:** Both parties must sign EXACT same transaction. Different outputs = different sighash = signatures don't combine.

**Solution:** Share the 32-byte sighash directly, not tx parameters.

```
1. Initiator creates tx, computes sighash
2. Initiator signs, sends sighash + signature
3. Responder verifies sighash matches expected tx
4. Responder signs SAME sighash
5. Initiator combines signatures, broadcasts
```

### Documented
- `docs/COOPERATIVE-CLOSE.md` - Full protocol and lessons learned
- `coordinate-close.ts` - Manual close coordination script

---

## Close Protocol Implementation (Late Afternoon)

### New Files Created
- **`src/channels/close.ts`** - Cooperative close protocol module
  - `createCloseRequest(channel, manager, localBalance, remoteBalance)` - Creates CloseRequest message
  - `signCloseRequest(request, channel, manager)` - Signs a received close request
  - `broadcastClose(request, acceptedSig, channel)` - Combines sigs, broadcasts

### Message Types Added to `messages.ts`
- `CLOSE_REQUEST` - Initiates cooperative close, includes sighash + initiator sig
- `CLOSE_ACCEPT` - Responder agrees, includes their signature
- `CLOSE_COMPLETE` - Final confirmation with broadcast txid

### Protocol Handlers in `protocol.ts`
- `initiateCooperativeClose(peerId, channelId)` - Start close flow
- `handleCloseRequest(peerId, msg)` - Auto-sign valid close requests
- `handleCloseAccept(peerId, msg)` - Combine sigs, broadcast
- `handleCloseComplete(peerId, msg)` - Cleanup after close
- `pendingCloseRequests: Map<string, CloseRequest>` - Track in-flight closes

### Daemon Endpoint (In Progress)
- Working on `POST /channel/close` endpoint in `src/daemon/index.ts`
- Will call `channelProtocol.initiateCooperativeClose(peerId, channelId)`
- Returns txid once broadcast succeeds

### Real Funded Channel
- Channel ID: `342a8f93-d529-49ba-9506-13a604314dbb`
- Funding TX: `9306d47516a0c69244990b8076453af71481edca62d689c2c684b7ff6a258270`
- Amount: 10,000 sats (5000 each)
- Status: Pending confirmation, needs `/channel/verify-open` after confirms

### Test Status
- 96 tests passed, 6 skipped
- All close protocol unit tests passing
